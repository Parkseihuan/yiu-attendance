<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ìš©ì¸ëŒ€í•™êµ êµì§ì› íšŒì˜ ì¶œì„</title>
  
  <style>
    :root {
      --primary: #667eea;
      --success: #48bb78;
      --error: #f56565;
      --warning: #ed8936;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --text-light: #718096;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
      background: linear-gradient(180deg, var(--primary) 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 15px;
      line-height: 1.5;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      min-height: calc(100vh - 30px);
      display: flex;
      flex-direction: column;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 25px 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .university-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
    }

    .meeting-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .meeting-description {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .form-container {
      flex: 1;
    }

    .status-indicator {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .status-ready {
      background: #f0fff4;
      border-color: var(--success);
      color: var(--success);
    }

    .status-checking {
      background: #fffbf0;
      border-color: var(--warning);
      color: var(--warning);
    }

    .status-error {
      background: #fef5e7;
      border-color: var(--error);
      color: var(--error);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 700;
      color: var(--text-primary);
      font-size: 15px;
    }

    .required {
      color: var(--error);
    }

    .form-group input {
      width: 100%;
      padding: 16px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      font-family: inherit;
      background: white;
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group input.invalid {
      border-color: var(--error);
      background: #fef5e7;
    }

    .validation-message {
      font-size: 13px;
      margin-top: 6px;
      color: var(--error);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .validation-message.show {
      opacity: 1;
    }

    .btn {
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
      font-family: inherit;
      min-height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: white;
      color: var(--text-primary);
      border: 2px solid #e2e8f0;
    }

    .btn:disabled {
      background: #e2e8f0;
      color: var(--text-light);
      cursor: not-allowed;
      transform: none;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .alert {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 14px;
      border-left: 4px solid;
    }

    .alert-success {
      background: #f0fff4;
      color: var(--success);
      border-color: var(--success);
    }

    .alert-error {
      background: #fef5e7;
      color: var(--error);
      border-color: var(--error);
    }

    .alert-info {
      background: #e6f3ff;
      color: var(--primary);
      border-color: var(--primary);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 30px 20px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .completion-message {
      background: linear-gradient(135deg, var(--success), #38a169);
      color: white;
      padding: 30px 25px;
      border-radius: 16px;
      text-align: center;
      margin-top: 20px;
      display: none;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .completion-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .completion-text {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .completion-details {
      font-size: 14px;
      opacity: 0.9;
      line-height: 1.5;
      white-space: pre-line;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 375px) {
      .container { padding: 10px; }
      .card { padding: 20px 15px; }
      .university-title { font-size: 20px; }
      .meeting-title { font-size: 16px; }
    }

    /* ë‹¤í¬ ëª¨ë“œ ì§€ì› */
    @media (prefers-color-scheme: dark) {
      .card {
        background: rgba(26, 32, 44, 0.95);
        color: #f7fafc;
      }
      
      .form-group input {
        background: #2d3748;
        color: #f7fafc;
        border-color: #4a5568;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <div class="card header">
      <h1 class="university-title">ìš©ì¸ëŒ€í•™êµ</h1>
      <h2 class="meeting-title" id="meetingTitle">êµì§ì› íšŒì˜ ì¶œì„</h2>
      <p class="meeting-description" id="meetingDescription">ì¶œì„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
    </div>

    <!-- í¼ -->
    <div class="card form-container">
      <div id="alertContainer"></div>
      
      <!-- ìƒíƒœ í‘œì‹œ -->
      <div class="status-indicator" id="statusIndicator">
        ğŸ”„ ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘...
      </div>
      
      <!-- ë¡œë”© -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>

      <!-- ì¶œì„ í¼ -->
      <form id="attendanceForm">
        <div class="form-group">
          <label for="name">
            ğŸ‘¤ ì„±ëª… <span class="required">*</span>
          </label>
          <input type="text" id="name" placeholder="í™ê¸¸ë™" maxlength="20" required>
          <div class="validation-message" id="name-validation"></div>
        </div>

        <div class="form-group">
          <label for="department">
            ğŸ¢ ì†Œì† <span class="required">*</span>
          </label>
          <input type="text" id="department" placeholder="ê²½ì˜í•™ê³¼, êµë¬´íŒ€ ë“±" maxlength="50" required>
          <div class="validation-message" id="department-validation"></div>
        </div>

        <div class="form-group">
          <label for="email">
            ğŸ“§ ì´ë©”ì¼ <span class="required">*</span>
          </label>
          <input type="email" id="email" placeholder="name@yongin.ac.kr" maxlength="100" required>
          <div class="validation-message" id="email-validation"></div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="recheckLocation()">
          ğŸ“ ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸
        </button>

        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
          âœ… ì¶œì„ ì²´í¬í•˜ê¸°
        </button>

        <!-- ì™„ë£Œ ë©”ì‹œì§€ -->
        <div class="completion-message" id="completionMessage">
          <div class="completion-icon">ğŸ“</div>
          <div class="completion-text">ì¶œì„ ì™„ë£Œ!</div>
          <div class="completion-details" id="completionDetails"></div>
        </div>
      </form>
    </div>

    <!-- í‘¸í„° -->
    <div class="footer">
      ğŸ“ ìš©ì¸ëŒ€í•™êµ ì¶œì„ì‹œìŠ¤í…œ Â© 2025
    </div>
  </div>

  <script>
    // ========================================
    // ğŸ”§ ì„¤ì • (ê´€ë¦¬ìê°€ ìˆ˜ì •)
    // ========================================
    
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxhmiLdQS4HG0kUJ168PFnFXFosVi6X65-SGjGMC4Hp9vreIRwomz1_gECCGTSDO2_m/exec'; // â¬…ï¸ ìƒˆ ë°°í¬ URLë¡œ ë³€ê²½
    
    // ========================================
    // ì „ì—­ ë³€ìˆ˜
    // ========================================
    
    let isLocationValid = false;
    let isSystemReady = false;
    let isCompleted = false;
    let isSubmitting = false;
    let deviceFingerprint = null;
    let lastKnownPosition = null;

    const SystemState = {
      INITIALIZING: 'initializing',
      READY: 'ready',
      CHECKING: 'checking',
      ERROR: 'error',
      COMPLETED: 'completed'
    };

    let currentState = SystemState.INITIALIZING;

    // ========================================
    // ì´ˆê¸°í™”
    // ========================================

    window.addEventListener('load', function() {
      console.log('ğŸ“ ìš©ì¸ëŒ€í•™êµ ì¶œì„ ì‹œìŠ¤í…œ ì‹œì‘');
      initializeSystem();
    });

    async function initializeSystem() {
      try {
        updateStatus('ğŸ”„ ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘... (1/5)', 'checking');

        // 1. ê¸°ê¸° ì •ë³´ ìˆ˜ì§‘
        await generateDeviceFingerprint();
        updateStatus('ğŸ”„ ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘... (2/5)', 'checking');

        // 2. ë°±ì—”ë“œ ì—°ê²° í™•ì¸
        await testBackendConnection();
        updateStatus('ğŸ”„ ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘... (3/5)', 'checking');

        // 3. ì„¤ì • ë¡œë“œ
        await loadSettings();
        updateStatus('ğŸ”„ ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘... (4/5)', 'checking');

        // 4. ìœ„ì¹˜ í™•ì¸ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
        const locationSuccess = await checkLocation();
        console.log('ìœ„ì¹˜ í™•ì¸ ê²°ê³¼:', locationSuccess);
        
        // 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupEventListeners();
        updateStatus('ğŸ”„ ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘... (5/5)', 'checking');

        // ì™„ë£Œ - ìœ„ì¹˜ í™•ì¸ ì„±ê³µ ì—¬ë¶€ì— ê´€ê³„ì—†ì´ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ
        currentState = SystemState.READY;
        isSystemReady = true;
        
        if (locationSuccess) {
          updateStatus('âœ… ì¶œì„ ì¤€ë¹„ ì™„ë£Œ', 'ready');
        } else {
          updateStatus('âš ï¸ ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ - ìœ„ì¹˜ í™•ì¸ í•„ìš”', 'checking');
          showAlert('ìœ„ì¹˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. "ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'info');
        }
        
        validateForm(); // í¼ ê²€ì¦ ì‹¤í–‰
        
      } catch (error) {
        console.error('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        currentState = SystemState.ERROR;
        updateStatus('âŒ ì‹œìŠ¤í…œ ì˜¤ë¥˜ - ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”', 'error');
        showAlert('ì‹œìŠ¤í…œ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.', 'error');
      }
    }

    // ========================================
    // ê¸°ê¸° ì •ë³´ ë° ì—°ê²°
    // ========================================

    async function generateDeviceFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('YU Mobile', 2, 2);

        deviceFingerprint = {
          userAgent: navigator.userAgent,
          screenInfo: `${screen.width}x${screen.height}x${screen.colorDepth}`,
          pixelRatio: window.devicePixelRatio || 1,
          timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          language: navigator.language,
          platform: navigator.platform,
          canvasFingerprint: canvas.toDataURL().substring(0, 100),
          touchPoints: navigator.maxTouchPoints || 0,
          timestamp: Date.now()
        };
        
      } catch (error) {
        deviceFingerprint = {
          userAgent: navigator.userAgent || 'unknown',
          timestamp: Date.now(),
          fallback: true
        };
      }
    }

    // ========================================
    // API í†µì‹  - JSONP ë°©ì‹ (CORS ìš°íšŒ)
    // ========================================

    /**
     * JSONP ë°©ì‹ìœ¼ë¡œ Google Apps Script í˜¸ì¶œ
     */
    async function callGoogleScript(method, params = null) {
      return new Promise((resolve, reject) => {
        const callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (30ì´ˆ)'));
        }, 30000);

        function cleanup() {
          if (window[callbackName]) {
            delete window[callbackName];
          }
          clearTimeout(timeoutId);
          const script = document.getElementById(callbackName);
          if (script) {
            document.head.removeChild(script);
          }
        }

        window[callbackName] = function(result) {
          cleanup();
          resolve(result);
        };

        const script = document.createElement('script');
        script.id = callbackName;
        script.onerror = () => {
          cleanup();
          reject(new Error('ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
        };

        // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
        let url = `${BACKEND_URL}?method=${encodeURIComponent(method)}&callback=${callbackName}`;
        
        if (params) {
          // GET ìš”ì²­ì´ë¯€ë¡œ paramsë¥¼ URL íŒŒë¼ë¯¸í„°ë¡œ ë³€í™˜
          const paramStr = encodeURIComponent(JSON.stringify(params));
          url += `&params=${paramStr}`;
        }

        script.src = url;
        document.head.appendChild(script);
      });
    }

    async function testBackendConnection() {
      try {
        const result = await callGoogleScript('testConnection');
        if (!result.success) {
          throw new Error(result.error || 'ì—°ê²° ì‹¤íŒ¨');
        }
        return result;
      } catch (error) {
        console.error('ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨:', error);
        throw new Error('ë°±ì—”ë“œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Google Apps Script ì›¹ì•±ì´ ì˜¬ë°”ë¥´ê²Œ ë°°í¬ë˜ì—ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
      }
    }

    async function loadSettings() {
      try {
        const result = await callGoogleScript('getSettings');
        if (result && result.success !== false) {
          // resultê°€ ì§ì ‘ settings ê°ì²´ì´ê±°ë‚˜ result.dataì— ìˆì„ ìˆ˜ ìˆìŒ
          const settings = result.data || result;
          document.getElementById('meetingTitle').textContent = 
            settings.meeting_title || 'êµì§ì› íšŒì˜ ì¶œì„';
          document.getElementById('meetingDescription').textContent = 
            settings.meeting_description || 'ì¶œì„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
        }
      } catch (error) {
        console.warn('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ========================================
    // ìœ„ì¹˜ í™•ì¸
    // ========================================

    function checkLocation() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          updateStatus('âŒ ìœ„ì¹˜ ì„œë¹„ìŠ¤ ë¯¸ì§€ì› - ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•˜ì„¸ìš”', 'error');
          resolve(false);
          return;
        }

        updateStatus('ğŸ“ ìœ„ì¹˜ í™•ì¸ì¤‘... (ìµœëŒ€ 10ì´ˆ)', 'checking');

        // ì „ì—­ íƒ€ì„ì•„ì›ƒ ì„¤ì • (ì´ˆê¸°í™” ì¤‘ë‹¨ ë°©ì§€)
        const globalTimeout = setTimeout(() => {
          console.log('ìœ„ì¹˜ í™•ì¸ ì „ì—­ íƒ€ì„ì•„ì›ƒ - ì‹œìŠ¤í…œ ì´ˆê¸°í™” ê³„ì†');
          isLocationValid = false;
          updateStatus('âš ï¸ ìœ„ì¹˜ í™•ì¸ ì§€ì—° - "ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”', 'checking');
          resolve(false);
        }, 12000); // 12ì´ˆ í›„ ê°•ì œ ì§„í–‰

        navigator.geolocation.getCurrentPosition(
          function(position) {
            clearTimeout(globalTimeout);
            lastKnownPosition = position;
            isLocationValid = true;
            
            const accuracy = position.coords.accuracy;
            let message = 'ğŸ“ ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
            if (accuracy > 100) {
              message += ` (ì˜¤ì°¨ ${Math.round(accuracy)}m)`;
            }
            
            updateStatus(message, 'ready');
            console.log('ìœ„ì¹˜ í™•ì¸ ì„±ê³µ:', position.coords.latitude, position.coords.longitude);
            resolve(true);
          },
          function(error) {
            clearTimeout(globalTimeout);
            isLocationValid = false;
            let errorMessage = 'âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨';
            
            console.log('ìœ„ì¹˜ í™•ì¸ ì˜¤ë¥˜:', error.code, error.message);
            
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMessage = 'âŒ ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
                setTimeout(() => {
                  showAlert('ğŸ”§ ìœ„ì¹˜ ê¶Œí•œ ì„¤ì • ë°©ë²•:\n\n1. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì™¼ìª½ ìë¬¼ì‡ /ì •ë³´ ì•„ì´ì½˜ í´ë¦­\n2. "ìœ„ì¹˜" ë˜ëŠ” "Location"ì„ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½\n3. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ í›„ "ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸" í´ë¦­', 'info');
                }, 1000);
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = 'âŒ GPS ì‹ í˜¸ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                break;
              case error.TIMEOUT:
                errorMessage = 'âŒ ìœ„ì¹˜ í™•ì¸ ì‹œê°„ ì´ˆê³¼';
                break;
            }
            
            updateStatus(errorMessage + ' - "ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”', 'checking');
            resolve(false);
          },
          {
            enableHighAccuracy: false, // ë¹ ë¥¸ ìœ„ì¹˜ í™•ì¸ì„ ìœ„í•´ ì •í™•ë„ ë‚®ì¶¤
            timeout: 10000, // 10ì´ˆë¡œ ë‹¨ì¶•
            maximumAge: 600000 // ìºì‹œ ì‹œê°„ 10ë¶„ìœ¼ë¡œ í™•ëŒ€
          }
        );
      });
    }

    async function recheckLocation() {
      const button = event.target;
      const originalText = button.textContent;
      
      button.disabled = true;
      button.textContent = 'ğŸ“ í™•ì¸ì¤‘...';
      
      try {
        updateStatus('ğŸ“ ìœ„ì¹˜ ì¬í™•ì¸ ì¤‘...', 'checking');
        
        // ë” ì ê·¹ì ì¸ ìœ„ì¹˜ í™•ì¸ ì‹œë„
        const locationSuccess = await new Promise((resolve) => {
          if (!navigator.geolocation) {
            resolve(false);
            return;
          }

          const timeout = setTimeout(() => {
            resolve(false);
          }, 8000); // 8ì´ˆ íƒ€ì„ì•„ì›ƒ

          navigator.geolocation.getCurrentPosition(
            function(position) {
              clearTimeout(timeout);
              lastKnownPosition = position;
              isLocationValid = true;
              
              const accuracy = position.coords.accuracy;
              let message = 'ğŸ“ ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
              if (accuracy > 100) {
                message += ` (ì˜¤ì°¨ ${Math.round(accuracy)}m)`;
              }
              
              updateStatus(message, 'ready');
              console.log('ìœ„ì¹˜ ì¬í™•ì¸ ì„±ê³µ:', position.coords.latitude, position.coords.longitude);
              resolve(true);
            },
            function(error) {
              clearTimeout(timeout);
              console.log('ìœ„ì¹˜ ì¬í™•ì¸ ì‹¤íŒ¨:', error.code, error.message);
              
              let errorMessage = 'âŒ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨';
              
              switch(error.code) {
                case error.PERMISSION_DENIED:
                  errorMessage = 'âŒ ìœ„ì¹˜ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤';
                  showAlert('ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.\n\nì„¤ì • ë°©ë²•:\n1. ì£¼ì†Œì°½ ì™¼ìª½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ í´ë¦­\n2. ìœ„ì¹˜ ê¶Œí•œì„ "í—ˆìš©"ìœ¼ë¡œ ë³€ê²½\n3. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨', 'error');
                  break;
                case error.POSITION_UNAVAILABLE:
                  errorMessage = 'âŒ GPS ì‹ í˜¸ë¥¼ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                  showAlert('ì‹¤ë‚´ì—ì„œëŠ” GPS ì‹ í˜¸ê°€ ì•½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì°½ê°€ë¡œ ì´ë™í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                  break;
                case error.TIMEOUT:
                  errorMessage = 'âŒ ìœ„ì¹˜ í™•ì¸ ì‹œê°„ ì´ˆê³¼';
                  showAlert('ìœ„ì¹˜ í™•ì¸ì´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤.\në„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                  break;
              }
              
              updateStatus(errorMessage, 'error');
              isLocationValid = false;
              resolve(false);
            },
            {
              enableHighAccuracy: true, // ë” ì •í™•í•œ ìœ„ì¹˜
              timeout: 7000, // 7ì´ˆ íƒ€ì„ì•„ì›ƒ
              maximumAge: 60000 // 1ë¶„ ìºì‹œ
            }
          );
        });
        
        validateForm();
        
        if (locationSuccess) {
          showAlert('ìœ„ì¹˜ í™•ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    // ========================================
    // í¼ ì²˜ë¦¬
    // ========================================

    function setupEventListeners() {
      ['name', 'department', 'email'].forEach(field => {
        const element = document.getElementById(field);
        element.addEventListener('input', () => validateField(field));
        element.addEventListener('blur', () => validateField(field));
      });

      document.getElementById('attendanceForm').addEventListener('submit', handleFormSubmit);
    }

    function validateField(fieldName) {
      const element = document.getElementById(fieldName);
      const validationElement = document.getElementById(fieldName + '-validation');
      const value = element.value.trim();
      
      let isValid = true;
      let message = '';

      if (!value) {
        isValid = false;
        message = 'í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.';
      } else {
        switch(fieldName) {
          case 'name':
            if (value.length < 2) {
              isValid = false;
              message = 'ì´ë¦„ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            } else if (!/^[ê°€-í£a-zA-Z\s]+$/.test(value)) {
              isValid = false;
              message = 'í•œê¸€, ì˜ë¬¸ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            }
            break;
            
          case 'department':
            if (value.length < 2) {
              isValid = false;
              message = 'ì†Œì†ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            }
            break;
            
          case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
              isValid = false;
              message = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            }
            break;
        }
      }

      if (isValid) {
        element.classList.remove('invalid');
        validationElement.textContent = '';
        validationElement.classList.remove('show');
      } else {
        element.classList.add('invalid');
        validationElement.textContent = message;
        validationElement.classList.add('show');
      }

      validateForm();
      return isValid;
    }

    function validateForm() {
      if (isCompleted) return;

      const name = document.getElementById('name').value.trim();
      const department = document.getElementById('department').value.trim();
      const email = document.getElementById('email').value.trim();

      const nameValid = name.length >= 2 && /^[ê°€-í£a-zA-Z\s]+$/.test(name);
      const deptValid = department.length >= 2;
      const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      
      // ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ê³  ìœ„ì¹˜ê°€ í™•ì¸ë˜ì—ˆì„ ë•Œë§Œ í¼ ìœ íš¨
      const isFormValid = nameValid && deptValid && emailValid && isLocationValid && isSystemReady;
      
      updateSubmitButton(isFormValid);
    }

    function updateSubmitButton(isValid) {
      const submitBtn = document.getElementById('submitBtn');
      
      if (isCompleted) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'âœ… ì¶œì„ ì™„ë£Œ';
        submitBtn.classList.remove('pulse');
      } else if (isSubmitting) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ğŸ“§ ì²˜ë¦¬ì¤‘...';
        submitBtn.classList.remove('pulse');
      } else if (!isSystemReady) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘...';
        submitBtn.classList.remove('pulse');
      } else if (!isLocationValid) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ğŸ“ ìœ„ì¹˜ í™•ì¸ í•„ìš”';
        submitBtn.classList.remove('pulse');
      } else if (isValid) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'âœ… ì¶œì„ ì²´í¬í•˜ê¸°';
        submitBtn.classList.add('pulse');
      } else {
        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
        submitBtn.classList.remove('pulse');
      }
    }

    // ========================================
    // ì¶œì„ ì œì¶œ
    // ========================================

    function handleFormSubmit(e) {
      e.preventDefault();
      
      if (isSubmitting || isCompleted || !isSystemReady || !isLocationValid) {
        return;
      }

      const formData = {
        name: document.getElementById('name').value.trim(),
        department: document.getElementById('department').value.trim(),
        email: document.getElementById('email').value.trim()
      };

      submitAttendance(formData);
    }

    function submitAttendance(formData) {
      isSubmitting = true;
      updateSubmitButton(false);
      showLoading(true, 'ğŸ“§ ì¶œì„ ì •ë³´ ì œì¶œì¤‘...');

      if (lastKnownPosition) {
        processSubmission(formData, lastKnownPosition);
      } else {
        navigator.geolocation.getCurrentPosition(
          (position) => processSubmission(formData, position),
          (error) => {
            isSubmitting = false;
            showLoading(false);
            showAlert('ìœ„ì¹˜ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            updateSubmitButton(true);
          }
        );
      }
    }

    async function processSubmission(formData, position) {
      const attendanceData = {
        ...formData,
        latitude: position.coords.latitude,
        longitude: position.coords.longitude,
        accuracy: position.coords.accuracy,
        timestamp: new Date().toISOString(),
        ...deviceFingerprint
      };

      try {
        // JSONP ë°©ì‹ìœ¼ë¡œ ì¶œì„ ë°ì´í„° ì „ì†¡
        const result = await callGoogleScript('saveAttendance', attendanceData);
        
        isSubmitting = false;
        showLoading(false);
        
        if (result.success) {
          completeAttendance(result);
        } else {
          const message = result.message || result.error || 'ì¶œì„ ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          showAlert(message, 'error');
          updateSubmitButton(true);
        }
        
      } catch (error) {
        isSubmitting = false;
        showLoading(false);
        console.error('ì œì¶œ ì˜¤ë¥˜:', error);
        
        showAlert('ì¶œì„ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
        updateSubmitButton(true);
      }
    }

    function completeAttendance(result) {
      isCompleted = true;
      currentState = SystemState.COMPLETED;
      
      const completionDiv = document.getElementById('completionMessage');
      const completionDetails = document.getElementById('completionDetails');
      
      let details = `ì¶œì„ì: ${document.getElementById('name').value}\n`;
      details += `ì†Œì†: ${document.getElementById('department').value}\n`;
      details += `ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`;
      
      if (result.distance) {
        details += `\nê±°ë¦¬: ${result.distance}m`;
      }
      
      if (result.emailSent) {
        details += `\n\nğŸ“§ í™•ì¸ ì´ë©”ì¼ ë°œì†¡ë¨`;
      }
      
      completionDetails.textContent = details;
      completionDiv.style.display = 'block';
      
      updateSubmitButton(false);
      updateStatus('âœ… ì¶œì„ ì™„ë£Œ', 'ready');
      
      // ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”
      document.querySelectorAll('#attendanceForm input').forEach(input => {
        input.disabled = true;
      });

      // ìŠ¤í¬ë¡¤
      setTimeout(() => {
        completionDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 500);
    }

    // ========================================
    // UI í—¬í¼ í•¨ìˆ˜
    // ========================================

    function updateStatus(message, type) {
      const indicator = document.getElementById('statusIndicator');
      indicator.textContent = message;
      indicator.className = `status-indicator status-${type}`;
    }

    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(alert);

      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, type === 'success' ? 6000 : 5000);
    }

    function showLoading(show, text) {
      const loading = document.getElementById('loading');
      const form = document.getElementById('attendanceForm');
      const loadingText = document.getElementById('loadingText');
      
      if (show) {
        loadingText.textContent = text || 'ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...';
        loading.style.display = 'block';
        form.style.opacity = '0.5';
        form.style.pointerEvents = 'none';
      } else {
        loading.style.display = 'none';
        form.style.opacity = '1';
        form.style.pointerEvents = 'auto';
      }
    }

    console.log('ğŸ“ ìš©ì¸ëŒ€í•™êµ ì¶œì„ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
  </script>
</body>
</html>
