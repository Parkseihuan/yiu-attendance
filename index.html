<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#4f46e5">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>ìš©ì¸ëŒ€í•™êµ êµì§ì› íšŒì˜ ì¶œì„</title>
  
  <style>
    :root {
      --primary: #4f46e5;
      --primary-light: #6366f1;
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-light: #9ca3af;
      --background: #f8fafc;
      --surface: #ffffff;
      --border: #e5e7eb;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      padding: 20px;
      line-height: 1.6;
      overflow-x: hidden;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
      min-height: calc(100vh - 40px);
      min-height: calc(-webkit-fill-available - 40px);
      display: flex;
      flex-direction: column;
      gap: 20px;
      padding-bottom: env(safe-area-inset-bottom, 20px);
    }

    .card {
      background: var(--surface);
      border-radius: 24px;
      padding: 32px 28px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header {
      text-align: center;
      margin-bottom: 8px;
    }

    .university-title {
      font-size: 28px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .meeting-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .meeting-description {
      font-size: 15px;
      color: var(--text-secondary);
      opacity: 0.8;
    }

    .form-container {
      flex: 1;
    }

    .status-indicator {
      background: var(--background);
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 24px;
      min-height: 64px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      position: relative;
    }

    .status-ready {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      border-color: var(--success);
      color: var(--success);
    }

    .status-checking {
      background: linear-gradient(135deg, #fffbeb, #fef3c7);
      border-color: var(--warning);
      color: var(--warning);
    }

    .status-error {
      background: linear-gradient(135deg, #fef2f2, #fecaca);
      border-color: var(--error);
      color: var(--error);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 700;
      color: var(--text-primary);
      font-size: 15px;
    }

    .required {
      color: var(--error);
    }

    .form-group input {
      width: 100%;
      padding: 18px 20px;
      border: 2px solid var(--border);
      border-radius: 16px;
      font-size: 16px;
      font-family: inherit;
      background: var(--surface);
      color: var(--text-primary);
      transition: all 0.3s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
      transform: translateY(-2px);
    }

    .form-group input.invalid {
      border-color: var(--error);
      background: #fef2f2;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .validation-message {
      font-size: 13px;
      margin-top: 8px;
      color: var(--error);
      opacity: 0;
      transition: all 0.3s ease;
      transform: translateY(-5px);
    }

    .validation-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .btn {
      width: 100%;
      padding: 20px 24px;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 16px;
      font-family: inherit;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-light));
      color: white;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
      transform: translateY(0);
    }

    .btn-primary:not(:disabled):active {
      transform: translateY(2px);
      box-shadow: 0 5px 20px rgba(79, 70, 229, 0.4);
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text-secondary);
      border: 2px solid var(--border);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .btn-secondary:not(:disabled):active {
      transform: translateY(1px);
      background: var(--background);
    }

    .btn:disabled {
      background: var(--border);
      color: var(--text-light);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .alert {
      padding: 20px;
      border-radius: 16px;
      margin-bottom: 20px;
      font-weight: 600;
      font-size: 14px;
      border-left: 4px solid;
      animation: slideIn 0.5s ease-out;
      line-height: 1.5;
    }

    .alert-success {
      background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      color: var(--success);
      border-color: var(--success);
    }

    .alert-error {
      background: linear-gradient(135deg, #fef2f2, #fecaca);
      color: var(--error);
      border-color: var(--error);
    }

    .alert-info {
      background: linear-gradient(135deg, #eff6ff, #dbeafe);
      color: var(--primary);
      border-color: var(--primary);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      border: 3px solid rgba(79, 70, 229, 0.1);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .completion-message {
      background: linear-gradient(135deg, var(--success), #059669);
      color: white;
      padding: 40px 30px;
      border-radius: 24px;
      text-align: center;
      margin-top: 24px;
      display: none;
      animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .completion-icon {
      font-size: 64px;
      margin-bottom: 20px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .completion-text {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .completion-details {
      font-size: 15px;
      opacity: 0.95;
      line-height: 1.6;
      white-space: pre-line;
    }

    .footer {
      text-align: center;
      padding: 20px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 13px;
      font-weight: 500;
    }

    .location-hint {
      background: rgba(79, 70, 229, 0.1);
      border: 1px solid rgba(79, 70, 229, 0.2);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 20px;
      font-size: 14px;
      color: var(--primary);
      display: none;
      text-align: center;
    }

    .location-hint.show {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    .hidden {
      display: none;
    }

    /* ëª¨ë°”ì¼ ìµœì í™” */
    @media (max-width: 480px) {
      body { 
        padding: 16px; 
      }
      
      .container { 
        gap: 16px;
        padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
      }
      
      .card { 
        padding: 28px 24px; 
        border-radius: 20px;
      }
      
      .university-title { 
        font-size: 24px; 
      }
      
      .meeting-title { 
        font-size: 16px; 
      }
      
      .form-group input { 
        padding: 16px 18px; 
        font-size: 16px;
      }
      
      .btn {
        padding: 18px 20px;
        min-height: 56px;
        font-size: 15px;
      }
    }

    /* ì•„ì´í° X ì´ìƒ ë…¸ì¹˜ ëŒ€ì‘ */
    @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
      .container {
        padding-top: env(safe-area-inset-top, 0);
        padding-bottom: calc(env(safe-area-inset-bottom, 0) + 40px);
      }
    }

    /* ê°€ë¡œ ëª¨ë“œ ëŒ€ì‘ */
    @media (orientation: landscape) and (max-height: 500px) {
      .container {
        min-height: calc(100vh - 32px);
        gap: 12px;
      }
      
      .card {
        padding: 20px;
      }
      
      .header {
        margin-bottom: 4px;
      }
    }

    /* ë‹¤í¬ ëª¨ë“œ ì§€ì› */
    @media (prefers-color-scheme: dark) {
      :root {
        --surface: #1f2937;
        --background: #111827;
        --text-primary: #f9fafb;
        --text-secondary: #d1d5db;
        --border: #374151;
      }
      
      .card {
        background: var(--surface);
        border: 1px solid var(--border);
      }
      
      .form-group input {
        background: var(--surface);
        color: var(--text-primary);
        border-color: var(--border);
      }
      
      .form-group input:focus {
        background: var(--surface);
      }
      
      .btn-secondary {
        background: var(--surface);
        color: var(--text-secondary);
        border-color: var(--border);
      }
    }

    /* í‚¤ë³´ë“œ í‘œì‹œ ì‹œ ë ˆì´ì•„ì›ƒ ì¡°ì • */
    @media screen and (max-height: 500px) {
      .header {
        margin-bottom: 4px;
      }
      
      .university-title {
        font-size: 20px;
      }
      
      .meeting-title {
        font-size: 15px;
      }
      
      .form-group {
        margin-bottom: 16px;
      }
      
      .btn {
        margin-bottom: 12px;
      }
    }

    /* ì ‘ê·¼ì„± ê°œì„  */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- í—¤ë” -->
    <div class="card header">
      <h1 class="university-title">ìš©ì¸ëŒ€í•™êµ</h1>
      <h2 class="meeting-title" id="meetingTitle">êµì§ì› íšŒì˜ ì¶œì„</h2>
      <p class="meeting-description" id="meetingDescription">ì¶œì„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
    </div>

    <!-- ë©”ì¸ í¼ -->
    <div class="card form-container">
      <div id="alertContainer"></div>
      
      <!-- ìœ„ì¹˜ ê¶Œí•œ ì•ˆë‚´ (í•„ìš” ì‹œì—ë§Œ í‘œì‹œ) -->
      <div class="location-hint" id="locationHint">
        ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”. ë¸Œë¼ìš°ì €ì—ì„œ "í—ˆìš©" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
      
      <!-- ìƒíƒœ í‘œì‹œ -->
      <div class="status-indicator" id="statusIndicator">
        ì‹œì‘í•˜ëŠ” ì¤‘...
      </div>
      
      <!-- ë¡œë”© -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
      </div>

      <!-- ì¶œì„ í¼ -->
      <form id="attendanceForm">
        <div class="form-group">
          <label for="name">
            ì„±ëª… <span class="required">*</span>
          </label>
          <input type="text" id="name" placeholder="í™ê¸¸ë™" maxlength="20" required autocomplete="name">
          <div class="validation-message" id="name-validation"></div>
        </div>

        <div class="form-group">
          <label for="department">
            ì†Œì† <span class="required">*</span>
          </label>
          <input type="text" id="department" placeholder="ê²½ì˜í•™ê³¼, êµë¬´íŒ€ ë“±" maxlength="50" required autocomplete="organization">
          <div class="validation-message" id="department-validation"></div>
        </div>

        <div class="form-group">
          <label for="email">
            ì´ë©”ì¼ <span class="required">*</span>
          </label>
          <input type="email" id="email" placeholder="name@yongin.ac.kr" maxlength="100" required autocomplete="email">
          <div class="validation-message" id="email-validation"></div>
        </div>

        <!-- ì¶œì„ ì²´í¬ ë²„íŠ¼ (ë©”ì¸ ë²„íŠ¼) -->
        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
          ì¶œì„ ì²´í¬í•˜ê¸°
        </button>

        <!-- ìœ„ì¹˜ í™•ì¸ ë²„íŠ¼ (ë³´ì¡° ë²„íŠ¼) -->
        <button type="button" class="btn btn-secondary" onclick="recheckLocation()" id="locationBtn">
          ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸í•˜ê¸°
        </button>

        <!-- ì™„ë£Œ ë©”ì‹œì§€ -->
        <div class="completion-message" id="completionMessage">
          <div class="completion-icon">ğŸ‰</div>
          <div class="completion-text">ì¶œì„ ì™„ë£Œ!</div>
          <div class="completion-details" id="completionDetails"></div>
        </div>
      </form>
    </div>

    <!-- í‘¸í„° -->
    <div class="footer">
      ìš©ì¸ëŒ€í•™êµ ì¶œì„ì‹œìŠ¤í…œ Â© 2025
    </div>
  </div>

  <script>
    // ========================================
    // ì„¤ì • (ê´€ë¦¬ìê°€ ìˆ˜ì •)
    // ========================================
    
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxDrW9myjkTNajzH0Unwx43exmHteW8wwC-N8SuKr0tmG4BpWybve3NLYaSn4AhZSt7Cg/exec';
    
    // ========================================
    // ì „ì—­ ë³€ìˆ˜
    // ========================================
    
    let isLocationValid = false;
    let isSystemReady = false;
    let isCompleted = false;
    let isSubmitting = false;
    let deviceFingerprint = null;
    let lastKnownPosition = null;
    let locationRequested = false;

    // ìœ„ì¹˜ ì„¤ì •ê°’ (ë°±ì—”ë“œì—ì„œ ë¡œë“œë  ì˜ˆì •)
    let locationSettings = {
      target_latitude: 37.2420,
      target_longitude: 127.1775,
      location_radius: 500
    };

    // ì‹¤ë‚´ í™˜ê²½ ê°ì§€ ë° ë³´ì •
    let isIndoorEnvironment = false;
    let isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    const SystemState = {
      INITIALIZING: 'initializing',
      READY: 'ready',
      CHECKING: 'checking',
      ERROR: 'error',
      COMPLETED: 'completed'
    };

    let currentState = SystemState.INITIALIZING;

    // ========================================
    // ì´ˆê¸°í™” - ë¹ ë¥¸ ì‹œì‘
    // ========================================

    window.addEventListener('load', function() {
      console.log('ìš©ì¸ëŒ€í•™êµ ì¶œì„ ì‹œìŠ¤í…œ ì‹œì‘');
      quickStart();
    });

    async function quickStart() {
      try {
        // ì¦‰ì‹œ ì‹œì‘
        updateStatus('ì¤€ë¹„ ì¤‘...', 'checking');
        
        // 1. ê¸°ê¸° ì •ë³´ ìˆ˜ì§‘ (ë™ê¸°)
        generateDeviceFingerprint();
        
        // 2. ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ - ë°±ì—”ë“œëŠ” ë‚˜ì¤‘ì—
        currentState = SystemState.READY;
        isSystemReady = true;
        
        // 3. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupEventListeners();
        
        // 4. ë°±ì—”ë“œì—ì„œ ì„¤ì • ë¡œë“œ (ë°±ê·¸ë¼ìš´ë“œ)
        backgroundInit();
        
        // 5. ìë™ ìœ„ì¹˜ ìš”ì²­ ì‹œì‘ (ì„¤ì • ë¡œë“œ í›„)
        setTimeout(() => {
          autoLocationCheck();
        }, 1000);
        
        console.log('ë¹ ë¥¸ ì‹œì‘ ì™„ë£Œ');
        
      } catch (error) {
        console.error('ë¹ ë¥¸ ì‹œì‘ ì˜¤ë¥˜:', error);
        fallbackInit();
      }
    }

    // ë°±ê·¸ë¼ìš´ë“œ ì´ˆê¸°í™” (ì‹œìŠ¤í…œ ì°¨ë‹¨ ì•ˆí•¨)
    async function backgroundInit() {
      try {
        console.log('ë°±ê·¸ë¼ìš´ë“œ ì´ˆê¸°í™” ì‹œì‘');
        
        // ì„¤ì • ë¡œë“œ ì‹œë„
        try {
          await loadSettings();
          console.log('ì„¤ì • ë¡œë“œ ì™„ë£Œ');
        } catch (error) {
          console.log('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©:', error);
        }
        
        // ë°±ì—”ë“œ ì—°ê²° í…ŒìŠ¤íŠ¸ (ë‚˜ì¤‘ì—)
        setTimeout(async () => {
          try {
            await testBackendConnection();
            console.log('ë°±ì—”ë“œ ì—°ê²° í™•ì¸');
            
            // ì—°ê²° ì„±ê³µ ì‹œ ì„¤ì • ë‹¤ì‹œ ë¡œë“œ
            try {
              await loadSettings();
              console.log('ì—°ê²° í›„ ì„¤ì • ì¬ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
              console.log('ì¬ë¡œë“œ ì‹¤íŒ¨');
            }
          } catch (error) {
            console.log('ë°±ì—”ë“œ ì—°ê²° ì§€ì—°, ê³„ì† ì‹œë„ì¤‘');
            retryBackendConnection();
          }
        }, 1000);
        
      } catch (error) {
        console.log('ë°±ê·¸ë¼ìš´ë“œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
      }
    }

    // ë°±ì—”ë“œ ì¬ì—°ê²° ì‹œë„
    let retryCount = 0;
    async function retryBackendConnection() {
      if (retryCount < 3) {
        retryCount++;
        setTimeout(async () => {
          try {
            await testBackendConnection();
            console.log(`ë°±ì—”ë“œ ì—°ê²° ì„±ê³µ (${retryCount}íšŒ ì‹œë„)`);
          } catch (error) {
            console.log(`ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ ${retryCount}/3`);
            retryBackendConnection();
          }
        }, 5000 * retryCount);
      }
    }

    // í´ë°± ì´ˆê¸°í™”
    function fallbackInit() {
      currentState = SystemState.READY;
      isSystemReady = true;
      setupEventListeners();
      updateStatus('ìœ„ì¹˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'checking');
      showLocationHint();
    }

    // ========================================
    // ì„¤ì •ê°’ ë¡œë“œ (ìˆ˜ì •ëœ ë²„ì „)
    // ========================================

    async function loadSettings() {
      try {
        const result = await callGoogleScript('getSettings');
        if (result && result.success !== false) {
          const settings = result.data || result;
          
          // UI ì—…ë°ì´íŠ¸
          document.getElementById('meetingTitle').textContent = 
            settings.meeting_title || 'êµì§ì› íšŒì˜ ì¶œì„';
          document.getElementById('meetingDescription').textContent = 
            settings.meeting_description || 'ì¶œì„ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
          
          // ìœ„ì¹˜ ì„¤ì • ì €ì¥
          locationSettings = {
            target_latitude: parseFloat(settings.target_latitude) || 37.2420,
            target_longitude: parseFloat(settings.target_longitude) || 127.1775,
            location_radius: parseFloat(settings.location_radius) || 500
          };
          
          console.log('ìœ„ì¹˜ ì„¤ì • ë¡œë“œ ì™„ë£Œ:', locationSettings);
        }
      } catch (error) {
        console.warn('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ========================================
    // ìë™ ìœ„ì¹˜ í™•ì¸
    // ========================================

    function autoLocationCheck() {
      if (!navigator.geolocation) {
        updateStatus('ìœ„ì¹˜ ì„œë¹„ìŠ¤ ë¯¸ì§€ì›', 'error');
        showLocationHint();
        return;
      }

      updateStatus('ìœ„ì¹˜ í™•ì¸ì¤‘...', 'checking');
      showLocationHint();
      
      // ëª¨ë°”ì¼ì—ì„œë„ ë†’ì€ ì •í™•ë„ë¡œ ìœ„ì¹˜ í™•ì¸
      const timeoutId = setTimeout(() => {
        if (!isLocationValid) {
          updateStatus('ìœ„ì¹˜ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤', 'checking');
          hideLocationHint();
        }
      }, 12000);

      // 1ì°¨: ë¹ ë¥¸ í™•ì¸
      navigator.geolocation.getCurrentPosition(
        function(position) {
          clearTimeout(timeoutId);
          console.log('1ì°¨ ìœ„ì¹˜ í™•ì¸:', position.coords.accuracy + 'm ì •í™•ë„');
          
          // ì •í™•ë„ê°€ 100m ì´í•˜ë©´ ë°”ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ 2ì°¨ í™•ì¸
          if (position.coords.accuracy <= 100) {
            handleLocationSuccess(position);
          } else {
            console.log('ì •í™•ë„ê°€ ë‚®ì•„ì„œ 2ì°¨ í™•ì¸ ì‹œì‘');
            getHighAccuracyLocation(position);
          }
        },
        function(error) {
          clearTimeout(timeoutId);
          console.log('1ì°¨ ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨, 2ì°¨ í™•ì¸ ì‹œì‘');
          getHighAccuracyLocation(null);
        },
        {
          enableHighAccuracy: false,
          timeout: 8000,
          maximumAge: 60000
        }
      );
    }

    // ê³ ì •ë°€ ìœ„ì¹˜ í™•ì¸
    function getHighAccuracyLocation(fallbackPosition) {
      updateStatus('ì •í™•í•œ ìœ„ì¹˜ í™•ì¸ì¤‘...', 'checking');
      
      navigator.geolocation.getCurrentPosition(
        function(position) {
          console.log('2ì°¨ ìœ„ì¹˜ í™•ì¸:', position.coords.accuracy + 'm ì •í™•ë„');
          handleLocationSuccess(position);
        },
        function(error) {
          console.log('2ì°¨ ìœ„ì¹˜ í™•ì¸ë„ ì‹¤íŒ¨');
          if (fallbackPosition) {
            console.log('1ì°¨ ê²°ê³¼ë¡œ í´ë°±');
            handleLocationSuccess(fallbackPosition);
          } else {
            handleLocationError(error);
          }
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 30000
        }
      );
    }

    /**
     * ìœ„ì¹˜ ì„±ê³µ ì²˜ë¦¬
     */
    function handleLocationSuccess(position) {
      lastKnownPosition = position;
      
      const userLat = position.coords.latitude;
      const userLng = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      
      console.log('ì‚¬ìš©ì ìœ„ì¹˜:', { lat: userLat, lng: userLng, accuracy: accuracy });
      console.log('ëª©í‘œ ìœ„ì¹˜:', locationSettings);
      console.log('ëª¨ë°”ì¼ ê¸°ê¸°:', isMobile);
      
      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ë¯¸ë¦¬ ê±°ë¦¬ ê³„ì‚°
      const distance = calculateDistanceClient(
        userLat, userLng, 
        locationSettings.target_latitude, locationSettings.target_longitude
      );
      
      // ì‹¤ë‚´ í™˜ê²½ ë° ëª¨ë°”ì¼ ê¸°ê¸°ì— ë”°ë¥¸ ë™ì  ë°˜ê²½ ì¡°ì •
      let effectiveRadius = locationSettings.location_radius;
      
      // ì‹¤ë‚´ í™˜ê²½ ê°ì§€ (GPS ì •í™•ë„ê°€ 200m ì´ìƒì´ë©´ ì‹¤ë‚´ë¡œ ê°„ì£¼)
      isIndoorEnvironment = accuracy > 200;
      
      if (isMobile) {
        // ëª¨ë°”ì¼ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë°˜ê²½ì„ 2ë°°ë¡œ í™•ì¥
        effectiveRadius = Math.max(effectiveRadius * 2, 1000);
        
        if (isIndoorEnvironment) {
          // ì‹¤ë‚´ + ëª¨ë°”ì¼: ë°˜ê²½ì„ 3ë°°ë¡œ í™•ì¥
          effectiveRadius = Math.max(effectiveRadius * 1.5, 1500);
        }
      } else if (isIndoorEnvironment) {
        // ë°ìŠ¤í¬íƒ‘ + ì‹¤ë‚´: ë°˜ê²½ì„ 1.5ë°°ë¡œ í™•ì¥
        effectiveRadius = Math.max(effectiveRadius * 1.5, 800);
      }
      
      console.log('ê³„ì‚°ëœ ê±°ë¦¬:', distance, 'm');
      console.log('ê¸°ë³¸ í—ˆìš© ë°˜ê²½:', locationSettings.location_radius, 'm');
      console.log('ì¡°ì •ëœ í—ˆìš© ë°˜ê²½:', effectiveRadius, 'm');
      console.log('GPS ì •í™•ë„:', accuracy, 'm');
      console.log('ì‹¤ë‚´ í™˜ê²½:', isIndoorEnvironment ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤');
      console.log('ê±°ë¦¬ ê²€ì¦:', distance <= effectiveRadius ? 'í†µê³¼' : 'ì‹¤íŒ¨');
      
      // ê±°ë¦¬ ê²€ì¦ (ì¡°ì •ëœ ë°˜ê²½ ì‚¬ìš©)
      if (distance <= effectiveRadius) {
        isLocationValid = true;
        locationRequested = true;
        
        let message = 'ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ';
        if (distance < 100) {
          message += ' - ê°€ê¹Œì›€';
        } else if (distance < 300) {
          message += ` - ${Math.round(distance)}m`;
        } else {
          message += ` - ${Math.round(distance)}m (ì‹¤ë‚´ í™˜ê²½)`;
        }
        
        updateStatus(message, 'ready');
        hideLocationHint();
        validateForm();
        
        console.log('ìœ„ì¹˜ ê²€ì¦ ì„±ê³µ!');
        
        // ì‹¤ë‚´ í™˜ê²½ì´ë©´ì„œ ê±°ë¦¬ê°€ ì¢€ ìˆìœ¼ë©´ ì•ˆë‚´ ë©”ì‹œì§€
        if (isIndoorEnvironment && distance > 500) {
          showAlert(
            `ì‹¤ë‚´ í™˜ê²½ì—ì„œ ìœ„ì¹˜ê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
            `ê±°ë¦¬: ${Math.round(distance)}m\n` +
            `GPS ì •í™•ë„: ${Math.round(accuracy)}m\n\n` +
            `ì‹¤ë‚´ì—ì„œëŠ” GPSê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆì–´ í—ˆìš© ë°˜ê²½ì´ ìë™ìœ¼ë¡œ í™•ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`,
            'info'
          );
        }
        
      } else {
        // ê±°ë¦¬ê°€ ë„ˆë¬´ ë¨¼ ê²½ìš°
        isLocationValid = false;
        
        const errorMessage = `íšŒì˜ì‹¤ì—ì„œ ${Math.round(distance)}m ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤`;
        
        updateStatus(errorMessage, 'error');
        hideLocationHint();
        
        console.log('ìœ„ì¹˜ ê²€ì¦ ì‹¤íŒ¨:', {
          'í˜„ì¬ ê±°ë¦¬': Math.round(distance) + 'm',
          'ê¸°ë³¸ í—ˆìš© ë°˜ê²½': locationSettings.location_radius + 'm',
          'ì¡°ì •ëœ í—ˆìš© ë°˜ê²½': effectiveRadius + 'm',
          'ì´ˆê³¼ ê±°ë¦¬': Math.round(distance - effectiveRadius) + 'm',
          'GPS ì •í™•ë„': Math.round(accuracy) + 'm',
          'ì‹¤ë‚´ í™˜ê²½': isIndoorEnvironment ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'
        });
        
        let errorDetail = `ìœ„ì¹˜ê°€ íšŒì˜ì‹¤ì—ì„œ ë„ˆë¬´ ë©€ë¦¬ ë–¨ì–´ì ¸ ìˆìŠµë‹ˆë‹¤.\n\n`;
        errorDetail += `í˜„ì¬ ê±°ë¦¬: ${Math.round(distance)}m\n`;
        errorDetail += `í—ˆìš© ê±°ë¦¬: ${effectiveRadius}m ì´ë‚´\n`;
        errorDetail += `ì´ˆê³¼ ê±°ë¦¬: ${Math.round(distance - effectiveRadius)}m\n`;
        errorDetail += `GPS ì •í™•ë„: ${Math.round(accuracy)}m\n\n`;
        
        if (isMobile && isIndoorEnvironment) {
          errorDetail += `ì‹¤ë‚´ ëª¨ë°”ì¼ í™˜ê²½ ì•ˆë‚´:\n`;
          errorDetail += `â€¢ GPS ì‹ í˜¸ê°€ ê±´ë¬¼ì— ì°¨ë‹¨ë˜ì–´ ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n`;
          errorDetail += `â€¢ WiFiê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”\n`;
          errorDetail += `â€¢ ê°€ëŠ¥í•˜ë©´ ì°½ê°€ë¡œ ì´ë™í•´ë³´ì„¸ìš”\n`;
          errorDetail += `â€¢ "ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸í•˜ê¸°"ë¥¼ ì—¬ëŸ¬ ë²ˆ ì‹œë„í•´ë³´ì„¸ìš”\n\n`;
          errorDetail += `ê·¸ë˜ë„ ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`;
        } else if (isIndoorEnvironment) {
          errorDetail += `ì‹¤ë‚´ í™˜ê²½ì—ì„œëŠ” GPSê°€ ë¶€ì •í™•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n`;
          errorDetail += `ì°½ê°€ë‚˜ ì¶œì…êµ¬ ê·¼ì²˜ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”.`;
        } else {
          errorDetail += `íšŒì˜ì‹¤ ê·¼ì²˜ë¡œ ì´ë™í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`;
        }
        
        showAlert(errorDetail, 'error');
        validateForm();
      }
    }

    function handleLocationError(error) {
      isLocationValid = false;
      let errorMessage = 'ìœ„ì¹˜ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤';
      let alertMessage = '';
      
      console.log('ìœ„ì¹˜ ì˜¤ë¥˜:', error.code, error.message);
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = 'ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤';
          alertMessage = `ìœ„ì¹˜ ê¶Œí•œ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤:\n\n`;
          
          // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ë³„ ì•ˆë‚´
          const userAgent = navigator.userAgent;
          if (userAgent.includes('iPhone') || userAgent.includes('iPad')) {
            alertMessage += `ğŸ“± iOS Safari:\n`;
            alertMessage += `1. ì„¤ì • > ê°œì¸ ì •ë³´ ë³´í˜¸ ë° ë³´ì•ˆ > ìœ„ì¹˜ ì„œë¹„ìŠ¤\n`;
            alertMessage += `2. Safari ì›¹ì‚¬ì´íŠ¸ > ì´ ì›¹ì‚¬ì´íŠ¸ í—ˆìš©\n\n`;
          } else if (userAgent.includes('Android')) {
            alertMessage += `ğŸ“± Android Chrome:\n`;
            alertMessage += `1. ì£¼ì†Œì°½ ì™¼ìª½ ğŸ”’ ì•„ì´ì½˜ í´ë¦­\n`;
            alertMessage += `2. ìœ„ì¹˜ > í—ˆìš© ì„ íƒ\n\n`;
          } else {
            alertMessage += `ğŸ’» ë°ìŠ¤í¬íƒ‘:\n`;
            alertMessage += `1. ì£¼ì†Œì°½ ì™¼ìª½ ğŸ”’ ì•„ì´ì½˜ í´ë¦­\n`;
            alertMessage += `2. ìœ„ì¹˜ > í—ˆìš© ì„ íƒ\n\n`;
          }
          
          alertMessage += `3. "ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸í•˜ê¸°" ë²„íŠ¼ í´ë¦­`;
          break;
          
        case error.POSITION_UNAVAILABLE:
          errorMessage = 'GPS ì‹ í˜¸ê°€ ì•½í•©ë‹ˆë‹¤';
          alertMessage = `GPS ì‹ í˜¸ë¥¼ ê°œì„ í•˜ëŠ” ë°©ë²•:\n\n`;
          alertMessage += `ğŸŒ ìœ„ì¹˜ ê°œì„ :\n`;
          alertMessage += `â€¢ ì°½ê°€ë‚˜ ì‹¤ì™¸ë¡œ ì´ë™í•´ë³´ì„¸ìš”\n`;
          alertMessage += `â€¢ ê±´ë¬¼ ë‚´ë¶€ì—ì„œëŠ” WiFi ì—°ê²° í™•ì¸\n`;
          alertMessage += `â€¢ ì§€í•˜ì‹¤ì´ë‚˜ ë°€íëœ ê³µê°„ í”¼í•˜ê¸°\n\n`;
          alertMessage += `ğŸ“¶ ì—°ê²° í™•ì¸:\n`;
          alertMessage += `â€¢ WiFi ë˜ëŠ” ëª¨ë°”ì¼ ë°ì´í„° ì—°ê²° ìƒíƒœ\n`;
          alertMessage += `â€¢ ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ë¡œ ë³€ê²½ ì‹œë„\n\n`;
          alertMessage += `ì ì‹œ í›„ "ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸í•˜ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”.`;
          break;
          
        case error.TIMEOUT:
          errorMessage = 'ìœ„ì¹˜ í™•ì¸ ì‹œê°„ì´ˆê³¼';
          alertMessage = `ìœ„ì¹˜ í™•ì¸ì´ ì˜¤ë˜ ê±¸ë¦¬ê³  ìˆìŠµë‹ˆë‹¤:\n\n`;
          alertMessage += `â° í•´ê²° ë°©ë²•:\n`;
          alertMessage += `â€¢ ì ì‹œ ê¸°ë‹¤ë¦° í›„ ë‹¤ì‹œ ì‹œë„\n`;
          alertMessage += `â€¢ ë‹¤ë¥¸ ì¥ì†Œë¡œ ì´ë™ (ì‹¤ì™¸ ê¶Œì¥)\n`;
          alertMessage += `â€¢ ê¸°ê¸° ì¬ì‹œì‘ í›„ ì¬ì‹œë„\n`;
          alertMessage += `â€¢ WiFi/ëª¨ë°”ì¼ ë°ì´í„° ì¬ì—°ê²°\n\n`;
          alertMessage += `ë¬¸ì œê°€ ê³„ì†ë˜ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`;
          break;
      }
      
      updateStatus(errorMessage, 'checking');
      
      if (alertMessage) {
        setTimeout(() => showAlert(alertMessage, 'info'), 1000);
      }
      
      hideLocationHint();
      validateForm();
    }

    /**
     * í´ë¼ì´ì–¸íŠ¸ ì¸¡ ê±°ë¦¬ ê³„ì‚° (Haversine formula)
     */
    function calculateDistanceClient(lat1, lng1, lat2, lng2) {
      const R = 6371000; // ì§€êµ¬ ë°˜ì§€ë¦„ (ë¯¸í„°)
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLng = (lng2 - lng1) * Math.PI / 180;
      
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
      
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      
      return R * c;
    }

    // ========================================
    // ìœ„ì¹˜ ì¬í™•ì¸
    // ========================================

    async function recheckLocation() {
      const button = document.getElementById('locationBtn');
      const originalText = button.textContent;
      
      button.disabled = true;
      button.textContent = 'í™•ì¸ì¤‘...';
      
      try {
        if (!navigator.geolocation) {
          throw new Error('ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤');
        }

        updateStatus('ì •í™•í•œ ìœ„ì¹˜ í™•ì¸ì¤‘...', 'checking');
        showLocationHint();
        
        // ì‹¤ë‚´ í™˜ê²½ì—ì„œëŠ” ë” ë§ì€ ì‹œë„ë¡œ ìµœì ì˜ ìœ„ì¹˜ ì°¾ê¸°
        const positions = [];
        const maxAttempts = isMobile ? 5 : 3; // ëª¨ë°”ì¼ì—ì„œ ë” ë§ì€ ì‹œë„
        
        for (let i = 0; i < maxAttempts; i++) {
          try {
            updateStatus(`ìœ„ì¹˜ í™•ì¸ ì‹œë„ ${i + 1}/${maxAttempts}...`, 'checking');
            
            const position = await getPositionWithOptions({
              enableHighAccuracy: i === 0 ? false : true, // ì²« ë²ˆì§¸ëŠ” ë¹ ë¥´ê²Œ, ë‚˜ë¨¸ì§€ëŠ” ì •í™•í•˜ê²Œ
              timeout: i === 0 ? 8000 : 15000,
              maximumAge: i === 0 ? 30000 : 5000
            });
            
            positions.push(position);
            console.log(`ìœ„ì¹˜ ì‹œë„ ${i + 1}: ì •í™•ë„ ${Math.round(position.coords.accuracy)}m`);
            
            // ì •í™•ë„ê°€ ë§¤ìš° ì¢‹ìœ¼ë©´ ì¡°ê¸° ì¢…ë£Œ
            if (position.coords.accuracy < 50) {
              console.log('ë†’ì€ ì •í™•ë„ ë‹¬ì„±, ì¡°ê¸° ì¢…ë£Œ');
              break;
            }
            
            // ì‹œë„ ê°„ ê°„ê²© (GPS ì•ˆì •í™”)
            if (i < maxAttempts - 1) {
              await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
          } catch (error) {
            console.log(`ìœ„ì¹˜ ì‹œë„ ${i + 1} ì‹¤íŒ¨:`, error.message);
            // ê³„ì† ì‹œë„
          }
        }
        
        if (positions.length === 0) {
          throw new Error('ëª¨ë“  ìœ„ì¹˜ í™•ì¸ ì‹œë„ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
        }
        
        // ì—¬ëŸ¬ ìœ„ì¹˜ ê²°ê³¼ ì¤‘ ìµœì ê°’ ì„ íƒ
        let bestPosition;
        
        if (isMobile && isIndoorEnvironment) {
          // ì‹¤ë‚´ ëª¨ë°”ì¼: ëª©í‘œ ìœ„ì¹˜ì— ê°€ì¥ ê°€ê¹Œìš´ ê²°ê³¼ ì„ íƒ
          bestPosition = positions.reduce((closest, current) => {
            const currentDistance = calculateDistanceClient(
              current.coords.latitude, current.coords.longitude,
              locationSettings.target_latitude, locationSettings.target_longitude
            );
            const closestDistance = calculateDistanceClient(
              closest.coords.latitude, closest.coords.longitude,
              locationSettings.target_latitude, locationSettings.target_longitude
            );
            return currentDistance < closestDistance ? current : closest;
          });
        } else {
          // ì¼ë°˜ í™˜ê²½: ê°€ì¥ ì •í™•í•œ ê²°ê³¼ ì„ íƒ
          bestPosition = positions.reduce((best, current) => 
            current.coords.accuracy < best.coords.accuracy ? current : best
          );
        }
        
        const finalDistance = calculateDistanceClient(
          bestPosition.coords.latitude, bestPosition.coords.longitude,
          locationSettings.target_latitude, locationSettings.target_longitude
        );
        
        console.log('ì„ íƒëœ ìµœì  ìœ„ì¹˜:', {
          accuracy: Math.round(bestPosition.coords.accuracy) + 'm',
          distance: Math.round(finalDistance) + 'm',
          attempts: positions.length
        });
        
        handleLocationSuccess(bestPosition);
        
        if (isLocationValid) {
          showAlert(
            `ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ!\n\n` +
            `ê±°ë¦¬: ${Math.round(finalDistance)}m\n` +
            `GPS ì •í™•ë„: ${Math.round(bestPosition.coords.accuracy)}m\n` +
            `í™•ì¸ ì‹œë„: ${positions.length}íšŒ`,
            'success'
          );
        }
        
      } catch (error) {
        if (error.code !== undefined) {
          handleLocationError(error);
        } else {
          updateStatus('ìœ„ì¹˜ í™•ì¸ ì‹¤íŒ¨', 'error');
          showAlert(
            `ìœ„ì¹˜ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n` +
            `ì˜¤ë¥˜: ${error.message}\n\n` +
            `ì‹¤ë‚´ í™˜ê²½ì—ì„œëŠ” ë‹¤ìŒì„ ì‹œë„í•´ë³´ì„¸ìš”:\n` +
            `â€¢ ì°½ê°€ë‚˜ ì¶œì…êµ¬ ê·¼ì²˜ë¡œ ì´ë™\n` +
            `â€¢ WiFi ì—°ê²° í™•ì¸\n` +
            `â€¢ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„\n` +
            `â€¢ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜`,
            'error'
          );
        }
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    // Promise ê¸°ë°˜ ìœ„ì¹˜ í™•ì¸ í—¬í¼ í•¨ìˆ˜
    function getPositionWithOptions(options) {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(resolve, reject, options);
      });
    }

    // ========================================
    // ê¸°ê¸° ì •ë³´ (ë™ê¸° ì²˜ë¦¬)
    // ========================================

    function generateDeviceFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('YU Mobile', 2, 2);

        deviceFingerprint = {
          userAgent: navigator.userAgent,
          screenInfo: `${screen.width}x${screen.height}x${screen.colorDepth}`,
          pixelRatio: window.devicePixelRatio || 1,
          timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          language: navigator.language,
          platform: navigator.platform,
          canvasFingerprint: canvas.toDataURL().substring(0, 100),
          touchPoints: navigator.maxTouchPoints || 0,
          timestamp: Date.now()
        };
        
        console.log('ê¸°ê¸° ì •ë³´ ìˆ˜ì§‘ ì™„ë£Œ');
        
      } catch (error) {
        deviceFingerprint = {
          userAgent: navigator.userAgent || 'unknown',
          timestamp: Date.now(),
          fallback: true
        };
        console.log('ê¸°ê¸° ì •ë³´ ìˆ˜ì§‘ (í´ë°±)');
      }
    }

    // ========================================
    // API í†µì‹  - JSONP ë°©ì‹
    // ========================================

    async function callGoogleScript(method, params = null) {
      return new Promise((resolve, reject) => {
        const callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼ (20ì´ˆ)'));
        }, 20000);

        function cleanup() {
          if (window[callbackName]) {
            delete window[callbackName];
          }
          clearTimeout(timeoutId);
          const script = document.getElementById(callbackName);
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        }

        window[callbackName] = function(result) {
          cleanup();
          resolve(result);
        };

        const script = document.createElement('script');
        script.id = callbackName;
        script.onerror = () => {
          cleanup();
          reject(new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜'));
        };

        let url = `${BACKEND_URL}?method=${encodeURIComponent(method)}&callback=${callbackName}`;
        
        if (params) {
          const paramStr = encodeURIComponent(JSON.stringify(params));
          url += `&params=${paramStr}`;
        }

        script.src = url;
        document.head.appendChild(script);
      });
    }

    async function testBackendConnection() {
      const result = await callGoogleScript('testConnection');
      if (!result.success) {
        throw new Error(result.error || 'ì—°ê²° ì‹¤íŒ¨');
      }
      return result;
    }

    // ========================================
    // í¼ ì²˜ë¦¬
    // ========================================

    function setupEventListeners() {
      ['name', 'department', 'email'].forEach(field => {
        const element = document.getElementById(field);
        element.addEventListener('input', () => {
          validateField(field);
          validateForm();
        });
        element.addEventListener('blur', () => validateField(field));
        
        // ëª¨ë°”ì¼ í¬ì»¤ìŠ¤ ê°œì„ 
        element.addEventListener('focus', function() {
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });

      document.getElementById('attendanceForm').addEventListener('submit', handleFormSubmit);
      
      // ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸
      window.addEventListener('resize', () => {
        validateForm();
      });
    }

    function validateField(fieldName) {
      const element = document.getElementById(fieldName);
      const validationElement = document.getElementById(fieldName + '-validation');
      const value = element.value.trim();
      
      let isValid = true;
      let message = '';

      if (!value) {
        isValid = false;
        message = 'í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.';
      } else {
        switch(fieldName) {
          case 'name':
            if (value.length < 2) {
              isValid = false;
              message = 'ì´ë¦„ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            } else if (!/^[ê°€-í£a-zA-Z\s]+$/.test(value)) {
              isValid = false;
              message = 'í•œê¸€, ì˜ë¬¸ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            }
            break;
            
          case 'department':
            if (value.length < 2) {
              isValid = false;
              message = 'ì†Œì†ì€ 2ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            }
            break;
            
          case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
              isValid = false;
              message = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
            }
            break;
        }
      }

      if (isValid) {
        element.classList.remove('invalid');
        validationElement.textContent = '';
        validationElement.classList.remove('show');
      } else {
        element.classList.add('invalid');
        validationElement.textContent = message;
        validationElement.classList.add('show');
      }

      return isValid;
    }

    function validateForm() {
      if (isCompleted) return;

      const name = document.getElementById('name').value.trim();
      const department = document.getElementById('department').value.trim();
      const email = document.getElementById('email').value.trim();

      const nameValid = name.length >= 2 && /^[ê°€-í£a-zA-Z\s]+$/.test(name);
      const deptValid = department.length >= 2;
      const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      
      const isFormValid = nameValid && deptValid && emailValid && isLocationValid && isSystemReady;
      
      updateSubmitButton(isFormValid);
    }

    function updateSubmitButton(isValid) {
      const submitBtn = document.getElementById('submitBtn');
      
      if (isCompleted) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ì¶œì„ ì™„ë£Œ';
        submitBtn.classList.remove('pulse');
      } else if (isSubmitting) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ì²˜ë¦¬ì¤‘...';
        submitBtn.classList.remove('pulse');
      } else if (!isSystemReady) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘...';
        submitBtn.classList.remove('pulse');
      } else if (!isLocationValid) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ìœ„ì¹˜ í™•ì¸ í›„ ì¶œì„ ì²´í¬';
        submitBtn.classList.remove('pulse');
      } else if (isValid) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ì¶œì„ ì²´í¬í•˜ê¸°';
        submitBtn.classList.add('pulse');
      } else {
        submitBtn.disabled = true;
        submitBtn.textContent = 'ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”';
        submitBtn.classList.remove('pulse');
      }
    }

    // ========================================
    // ì¶œì„ ì œì¶œ
    // ========================================

    function handleFormSubmit(e) {
      e.preventDefault();
      
      if (isSubmitting || isCompleted || !isSystemReady || !isLocationValid) {
        return;
      }

      const formData = {
        name: document.getElementById('name').value.trim(),
        department: document.getElementById('department').value.trim(),
        email: document.getElementById('email').value.trim()
      };

      submitAttendance(formData);
    }

    function submitAttendance(formData) {
      isSubmitting = true;
      updateSubmitButton(false);
      showLoading(true, 'ì¶œì„ ì •ë³´ ì œì¶œì¤‘...');

      if (lastKnownPosition) {
        processSubmission(formData, lastKnownPosition);
      } else {
        navigator.geolocation.getCurrentPosition(
          (position) => processSubmission(formData, position),
          (error) => {
            isSubmitting = false;
            showLoading(false);
            showAlert('ìœ„ì¹˜ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n"ìœ„ì¹˜ ë‹¤ì‹œ í™•ì¸í•˜ê¸°" ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'error');
            updateSubmitButton(true);
          }
        );
      }
    }

    /**
     * ì¶œì„ ì œì¶œ ì „ ìµœì¢… ìœ„ì¹˜ í™•ì¸
     */
    async function processSubmission(formData, position) {
      const attendanceData = {
        ...formData,
        latitude: position.coords.latitude,
        longitude: position.coords.longitude,
        accuracy: position.coords.accuracy,
        timestamp: new Date().toISOString(),
        ...deviceFingerprint
      };

      // ì œì¶œ ì „ ë§ˆì§€ë§‰ìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ê±°ë¦¬ í™•ì¸
      const distance = calculateDistanceClient(
        position.coords.latitude, position.coords.longitude,
        locationSettings.target_latitude, locationSettings.target_longitude
      );

      if (distance > locationSettings.location_radius) {
        isSubmitting = false;
        showLoading(false);
        
        showAlert(
          `ì œì¶œ ì‹œì ì— ìœ„ì¹˜ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
          `í˜„ì¬ ê±°ë¦¬: ${Math.round(distance)}m\n` +
          `í—ˆìš© ê±°ë¦¬: ${locationSettings.location_radius}m ì´ë‚´\n\n` +
          `íšŒì˜ì‹¤ ê·¼ì²˜ì—ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`,
          'error'
        );
        
        isLocationValid = false;
        updateSubmitButton(false);
        return;
      }

      try {
        showLoading(true, 'ì¶œì„ ì •ë³´ ê²€ì¦ ë° ì œì¶œì¤‘...');
        
        const result = await callGoogleScript('saveAttendance', attendanceData);
        
        isSubmitting = false;
        showLoading(false);
        
        if (result.success) {
          completeAttendance(result);
        } else {
          const message = result.message || result.error || 'ì¶œì„ ì²´í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
          showAlert(message, 'error');
          
          // ìœ„ì¹˜ ì˜¤ë¥˜ì¸ ê²½ìš° ìœ„ì¹˜ ì¬í™•ì¸ ìœ ë„
          if (message.includes('íšŒì˜ì‹¤ì—ì„œ') || message.includes('ìœ„ì¹˜')) {
            isLocationValid = false;
            updateStatus('ìœ„ì¹˜ ì¬í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'checking');
          }
          
          updateSubmitButton(true);
        }
        
      } catch (error) {
        isSubmitting = false;
        showLoading(false);
        console.error('ì œì¶œ ì˜¤ë¥˜:', error);
        
        let errorMessage = 'ì¶œì„ ì²´í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        
        if (error.message && error.message.includes('ë„¤íŠ¸ì›Œí¬')) {
          errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        }
        
        showAlert(errorMessage, 'error');
        updateSubmitButton(true);
      }
    }

    function completeAttendance(result) {
      isCompleted = true;
      currentState = SystemState.COMPLETED;
      
      const completionDiv = document.getElementById('completionMessage');
      const completionDetails = document.getElementById('completionDetails');
      
      let details = `ì¶œì„ì: ${document.getElementById('name').value}\n`;
      details += `ì†Œì†: ${document.getElementById('department').value}\n`;
      details += `ì‹œê°„: ${new Date().toLocaleString('ko-KR')}`;
      
      if (result.distance) {
        details += `\nê±°ë¦¬: ${result.distance}m`;
      }
      
      if (result.emailSent) {
        details += `\n\ní™•ì¸ ì´ë©”ì¼ ë°œì†¡ë¨`;
      }
      
      completionDetails.textContent = details;
      completionDiv.style.display = 'block';
      
      updateSubmitButton(false);
      updateStatus('ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'ready');
      
      // ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”
      document.querySelectorAll('#attendanceForm input').forEach(input => {
        input.disabled = true;
      });

      // ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤
      setTimeout(() => {
        completionDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 500);
      
      // ì„±ê³µ í”¼ë“œë°± (ì§„ë™)
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
    }

    // ========================================
    // UI í—¬í¼ í•¨ìˆ˜
    // ========================================

    function updateStatus(message, type) {
      const indicator = document.getElementById('statusIndicator');
      indicator.textContent = message;
      indicator.className = `status-indicator status-${type}`;
    }

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(alert);

      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, type === 'success' ? 6000 : 8000);
    }

    function showLoading(show, text = 'ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...') {
      const loading = document.getElementById('loading');
      const form = document.getElementById('attendanceForm');
      const loadingText = document.getElementById('loadingText');
      
      if (show) {
        loadingText.textContent = text;
        loading.style.display = 'block';
        form.style.opacity = '0.5';
        form.style.pointerEvents = 'none';
      } else {
        loading.style.display = 'none';
        form.style.opacity = '1';
        form.style.pointerEvents = 'auto';
      }
    }

    function showLocationHint() {
      const hint = document.getElementById('locationHint');
      hint.classList.add('show');
    }

    function hideLocationHint() {
      const hint = document.getElementById('locationHint');
      hint.classList.remove('show');
    }

    // ========================================
    // ëª¨ë°”ì¼ ìµœì í™” ì´ë²¤íŠ¸
    // ========================================

    // ë·°í¬íŠ¸ ë³€ê²½ ëŒ€ì‘
    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        window.scrollTo(0, 0);
        validateForm();
      }, 500);
    });

    // í„°ì¹˜ í”¼ë“œë°±
    document.addEventListener('touchstart', function() {}, { passive: true });

    console.log('ìš©ì¸ëŒ€í•™êµ ì¶œì„ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ (ëª¨ë°”ì¼ ìµœì í™”)');
  </script>
</body>
</html>
