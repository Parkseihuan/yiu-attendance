<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>용인대학교 교직원 회의 출석</title>
  
  <style>
    :root {
      --primary: #667eea;
      --success: #48bb78;
      --error: #f56565;
      --warning: #ed8936;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --text-light: #718096;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
      background: linear-gradient(180deg, var(--primary) 0%, #764ba2 100%);
      min-height: 100vh;
      min-height: -webkit-fill-available; /* iOS Safari */
      padding: 12px;
      line-height: 1.5;
      overflow-x: hidden;
    }

    .container {
      max-width: 420px;
      margin: 0 auto;
      min-height: calc(100vh - 24px);
      min-height: calc(-webkit-fill-available - 24px); /* iOS Safari */
      display: flex;
      flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom, 20px); /* iOS 노치 대응 */
    }

    .card {
      background: rgba(255, 255, 255, 0.96);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 24px 20px;
      margin-bottom: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .header {
      text-align: center;
      margin-bottom: 16px;
    }

    .university-title {
      font-size: 22px;
      font-weight: 800;
      color: var(--primary);
      margin-bottom: 6px;
    }

    .meeting-title {
      font-size: 17px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 6px;
    }

    .meeting-description {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .form-container {
      flex: 1;
    }

    .status-indicator {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 20px;
      min-height: 54px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .status-ready {
      background: linear-gradient(135deg, #f0fff4, #e6fffa);
      border-color: var(--success);
      color: var(--success);
      animation: readyGlow 2s infinite;
    }

    .status-checking {
      background: linear-gradient(135deg, #fffbf0, #fef5e7);
      border-color: var(--warning);
      color: var(--warning);
    }

    .status-error {
      background: linear-gradient(135deg, #fef5e7, #fed7d7);
      border-color: var(--error);
      color: var(--error);
    }

    @keyframes readyGlow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 700;
      color: var(--text-primary);
      font-size: 15px;
    }

    .required {
      color: var(--error);
    }

    .form-group input {
      width: 100%;
      padding: 18px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      font-size: 16px;
      font-family: inherit;
      background: white;
      color: var(--text-primary);
      transition: all 0.3s ease;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      transform: translateY(-1px);
    }

    .form-group input.invalid {
      border-color: var(--error);
      background: #fef5e7;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .validation-message {
      font-size: 13px;
      margin-top: 6px;
      color: var(--error);
      opacity: 0;
      transition: opacity 0.3s ease;
      transform: translateY(-5px);
    }

    .validation-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    .btn {
      width: 100%;
      padding: 18px 20px;
      border: none;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 12px;
      font-family: inherit;
      min-height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), #5a67d8);
      color: white;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.35);
      transform: translateY(0);
    }

    .btn-primary:not(:disabled):active {
      transform: translateY(2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: var(--text-primary);
      border: 2px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .btn-secondary:not(:disabled):active {
      transform: translateY(1px);
      background: #f7fafc;
    }

    .btn:disabled {
      background: #e2e8f0;
      color: var(--text-light);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    .alert {
      padding: 16px 20px;
      border-radius: 16px;
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 14px;
      border-left: 4px solid;
      animation: slideIn 0.5s ease-out;
    }

    .alert-success {
      background: linear-gradient(135deg, #f0fff4, #e6fffa);
      color: var(--success);
      border-color: var(--success);
    }

    .alert-error {
      background: linear-gradient(135deg, #fef5e7, #fed7d7);
      color: var(--error);
      border-color: var(--error);
    }

    .alert-info {
      background: linear-gradient(135deg, #e6f3ff, #ebf8ff);
      color: var(--primary);
      border-color: var(--primary);
    }

    .loading {
      display: none;
      text-align: center;
      padding: 30px 20px;
    }

    .spinner {
      border: 3px solid rgba(102, 126, 234, 0.1);
      border-top: 3px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .completion-message {
      background: linear-gradient(135deg, var(--success), #38a169);
      color: white;
      padding: 30px 25px;
      border-radius: 20px;
      text-align: center;
      margin-top: 20px;
      display: none;
      animation: slideIn 0.8s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .completion-icon {
      font-size: 48px;
      margin-bottom: 15px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .completion-text {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .completion-details {
      font-size: 14px;
      opacity: 0.95;
      line-height: 1.6;
      white-space: pre-line;
    }

    .footer {
      text-align: center;
      padding: 16px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
    }

    .location-hint {
      background: rgba(102, 126, 234, 0.1);
      border: 1px solid rgba(102, 126, 234, 0.2);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--primary);
      display: none;
    }

    .location-hint.show {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    /* 모바일 최적화 */
    @media (max-width: 480px) {
      body { padding: 8px; }
      .container { 
        padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 20px);
      }
      .card { 
        padding: 20px 16px; 
        border-radius: 16px;
        margin-bottom: 12px;
      }
      .university-title { font-size: 20px; }
      .meeting-title { font-size: 16px; }
      .form-group input { 
        padding: 16px 14px; 
        font-size: 16px; /* iOS zoom 방지 */
      }
      .btn {
        padding: 16px 20px;
        min-height: 52px;
        font-size: 15px;
      }
    }

    /* 아이폰 X 이상 노치 대응 */
    @media screen and (device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) {
      .container {
        padding-top: env(safe-area-inset-top, 0);
        padding-bottom: calc(env(safe-area-inset-bottom, 0) + 30px);
      }
    }

    /* 가로 모드 대응 */
    @media (orientation: landscape) and (max-height: 500px) {
      .container {
        min-height: calc(100vh - 16px);
      }
      .card {
        margin-bottom: 8px;
        padding: 16px;
      }
      .header {
        margin-bottom: 12px;
      }
    }

    /* 다크 모드 지원 */
    @media (prefers-color-scheme: dark) {
      .card {
        background: rgba(26, 32, 44, 0.95);
        color: #f7fafc;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .form-group input {
        background: #2d3748;
        color: #f7fafc;
        border-color: #4a5568;
      }
      
      .form-group input:focus {
        border-color: var(--primary);
        background: #2d3748;
      }
      
      .btn-secondary {
        background: #2d3748;
        color: #f7fafc;
        border-color: #4a5568;
      }
    }

    /* 키보드 표시 시 레이아웃 조정 */
    @media screen and (max-height: 500px) {
      .header {
        margin-bottom: 8px;
      }
      .university-title {
        font-size: 18px;
      }
      .meeting-title {
        font-size: 15px;
      }
      .form-group {
        margin-bottom: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <div class="card header">
      <h1 class="university-title">용인대학교</h1>
      <h2 class="meeting-title" id="meetingTitle">교직원 회의 출석</h2>
      <p class="meeting-description" id="meetingDescription">출석 정보를 입력해주세요</p>
    </div>

    <!-- 폼 -->
    <div class="card form-container">
      <div id="alertContainer"></div>
      
      <!-- 위치 안내 -->
      <div class="location-hint" id="locationHint">
        📍 위치 권한을 허용해주세요. 브라우저에서 "허용" 버튼을 눌러주세요.
      </div>
      
      <!-- 상태 표시 -->
      <div class="status-indicator" id="statusIndicator">
        🚀 시작하는 중...
      </div>
      
      <!-- 로딩 -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">처리중입니다...</p>
      </div>

      <!-- 출석 폼 -->
      <form id="attendanceForm">
        <div class="form-group">
          <label for="name">
            👤 성명 <span class="required">*</span>
          </label>
          <input type="text" id="name" placeholder="홍길동" maxlength="20" required autocomplete="name">
          <div class="validation-message" id="name-validation"></div>
        </div>

        <div class="form-group">
          <label for="department">
            🏢 소속 <span class="required">*</span>
          </label>
          <input type="text" id="department" placeholder="경영학과, 교무팀 등" maxlength="50" required autocomplete="organization">
          <div class="validation-message" id="department-validation"></div>
        </div>

        <div class="form-group">
          <label for="email">
            📧 이메일 <span class="required">*</span>
          </label>
          <input type="email" id="email" placeholder="name@yongin.ac.kr" maxlength="100" required autocomplete="email">
          <div class="validation-message" id="email-validation"></div>
        </div>

        <button type="button" class="btn btn-secondary" onclick="recheckLocation()" id="locationBtn">
          📍 위치 확인하기
        </button>

        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
          ✅ 출석 체크하기
        </button>

        <!-- 완료 메시지 -->
        <div class="completion-message" id="completionMessage">
          <div class="completion-icon">🎉</div>
          <div class="completion-text">출석 완료!</div>
          <div class="completion-details" id="completionDetails"></div>
        </div>
      </form>
    </div>

    <!-- 푸터 -->
    <div class="footer">
      🎓 용인대학교 출석시스템 © 2025
    </div>
  </div>

  <script>
    // ========================================
    // 🔧 설정 (관리자가 수정)
    // ========================================
    
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxhmiLdQS4HG0kUJ168PFnFXFosVi6X65-SGjGMC4Hp9vreIRwomz1_gECCGTSDO2_m/exec'; // ⬅️ 새 배포 URL로 변경
    
    // ========================================
    // 전역 변수
    // ========================================
    
    let isLocationValid = false;
    let isSystemReady = false;
    let isCompleted = false;
    let isSubmitting = false;
    let deviceFingerprint = null;
    let lastKnownPosition = null;
    let locationRequested = false;

    const SystemState = {
      INITIALIZING: 'initializing',
      READY: 'ready',
      CHECKING: 'checking',
      ERROR: 'error',
      COMPLETED: 'completed'
    };

    let currentState = SystemState.INITIALIZING;

    // ========================================
    // 초기화 - 빠른 시작
    // ========================================

    window.addEventListener('load', function() {
      console.log('🎓 용인대학교 출석 시스템 시작');
      quickStart();
    });

    async function quickStart() {
      try {
        // 즉시 시작
        updateStatus('⚡ 빠른 시작...', 'checking');
        
        // 1. 기기 정보 수집 (동기)
        generateDeviceFingerprint();
        
        // 2. 시스템 준비 완료 - 백엔드는 나중에
        currentState = SystemState.READY;
        isSystemReady = true;
        
        // 3. 이벤트 리스너 설정
        setupEventListeners();
        
        // 4. 자동 위치 요청 시작
        autoLocationCheck();
        
        // 5. 백엔드는 백그라운드에서 (차단하지 않음)
        backgroundInit();
        
        console.log('🚀 빠른 시작 완료');
        
      } catch (error) {
        console.error('빠른 시작 오류:', error);
        fallbackInit();
      }
    }

    // 백그라운드 초기화 (시스템 차단 안함)
    async function backgroundInit() {
      try {
        console.log('🔄 백그라운드 초기화 시작');
        
        // 설정 로드 시도
        setTimeout(async () => {
          try {
            await loadSettings();
            console.log('✅ 설정 로드 완료');
          } catch (error) {
            console.log('⚠️ 설정 로드 실패, 기본값 사용');
          }
        }, 1000);
        
        // 백엔드 연결 테스트 (나중에)
        setTimeout(async () => {
          try {
            await testBackendConnection();
            console.log('✅ 백엔드 연결 확인');
          } catch (error) {
            console.log('⚠️ 백엔드 연결 지연, 계속 시도중');
            // 재시도 로직
            retryBackendConnection();
          }
        }, 2000);
        
      } catch (error) {
        console.log('백그라운드 초기화 오류:', error);
      }
    }

    // 백엔드 재연결 시도
    let retryCount = 0;
    async function retryBackendConnection() {
      if (retryCount < 3) {
        retryCount++;
        setTimeout(async () => {
          try {
            await testBackendConnection();
            console.log(`✅ 백엔드 연결 성공 (${retryCount}회 시도)`);
          } catch (error) {
            console.log(`⚠️ 백엔드 연결 실패 ${retryCount}/3`);
            retryBackendConnection();
          }
        }, 5000 * retryCount); // 점진적 지연
      }
    }

    // 폴백 초기화
    function fallbackInit() {
      currentState = SystemState.READY;
      isSystemReady = true;
      setupEventListeners();
      updateStatus('⚠️ 기본 모드로 시작 - 위치 확인 필요', 'checking');
      showLocationHint();
    }

    // ========================================
    // 자동 위치 확인
    // ========================================

    function autoLocationCheck() {
      if (!navigator.geolocation) {
        updateStatus('❌ 위치 서비스 미지원', 'error');
        showLocationHint();
        return;
      }

      updateStatus('📍 위치 확인중...', 'checking');
      showLocationHint();
      
      // 적극적 위치 요청
      const timeoutId = setTimeout(() => {
        if (!isLocationValid) {
          updateStatus('📍 위치 확인 - "위치 확인하기" 버튼을 눌러주세요', 'checking');
          hideLocationHint();
        }
      }, 8000);

      navigator.geolocation.getCurrentPosition(
        function(position) {
          clearTimeout(timeoutId);
          handleLocationSuccess(position);
        },
        function(error) {
          clearTimeout(timeoutId);
          handleLocationError(error);
        },
        {
          enableHighAccuracy: false, // 빠른 확인
          timeout: 7000,
          maximumAge: 300000 // 5분 캐시
        }
      );
    }

    function handleLocationSuccess(position) {
      lastKnownPosition = position;
      isLocationValid = true;
      locationRequested = true;
      
      const accuracy = position.coords.accuracy;
      let message = '✅ 위치 확인 완료';
      if (accuracy > 100) {
        message += ` (오차 ${Math.round(accuracy)}m)`;
      }
      
      updateStatus(message, 'ready');
      hideLocationHint();
      validateForm();
      
      console.log('📍 위치 확인 성공:', position.coords.latitude, position.coords.longitude);
    }

    function handleLocationError(error) {
      isLocationValid = false;
      let errorMessage = '📍 위치 확인 필요';
      let alertMessage = '';
      
      console.log('위치 오류:', error.code, error.message);
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          errorMessage = '📍 위치 권한 필요';
          alertMessage = '🔧 위치 권한 설정:\n\n1. 브라우저 주소창 자물쇠 아이콘 클릭\n2. "위치"를 "허용"으로 변경\n3. "위치 확인하기" 버튼 클릭';
          break;
        case error.POSITION_UNAVAILABLE:
          errorMessage = '📍 GPS 신호 약함';
          alertMessage = '📶 GPS 신호가 약합니다:\n\n• 창가로 이동해보세요\n• 잠시 후 다시 시도해보세요\n• WiFi가 연결되어 있는지 확인하세요';
          break;
        case error.TIMEOUT:
          errorMessage = '📍 위치 확인 시간초과';
          break;
      }
      
      updateStatus(errorMessage + ' - "위치 확인하기" 버튼을 눌러주세요', 'checking');
      
      if (alertMessage) {
        setTimeout(() => showAlert(alertMessage, 'info'), 1000);
      }
      
      hideLocationHint();
      validateForm();
    }

    // ========================================
    // 위치 재확인 (개선된 버전)
    // ========================================

    async function recheckLocation() {
      const button = document.getElementById('locationBtn');
      const originalText = button.textContent;
      
      button.disabled = true;
      button.textContent = '📍 확인중...';
      
      try {
        if (!navigator.geolocation) {
          throw new Error('위치 서비스를 지원하지 않는 기기입니다');
        }

        updateStatus('📍 위치 재확인중...', 'checking');
        showLocationHint();
        
        // Promise로 위치 확인
        const position = await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error('위치 확인 시간이 초과되었습니다'));
          }, 10000);

          navigator.geolocation.getCurrentPosition(
            (pos) => {
              clearTimeout(timeout);
              resolve(pos);
            },
            (err) => {
              clearTimeout(timeout);
              reject(err);
            },
            {
              enableHighAccuracy: true,
              timeout: 9000,
              maximumAge: 30000
            }
          );
        });
        
        handleLocationSuccess(position);
        showAlert('✅ 위치 확인이 완료되었습니다!', 'success');
        
      } catch (error) {
        if (error.code !== undefined) {
          // GeolocationPositionError
          handleLocationError(error);
        } else {
          // 일반 오류
          updateStatus('❌ 위치 확인 실패', 'error');
          showAlert(error.message, 'error');
        }
      } finally {
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    // ========================================
    // 기기 정보 (동기 처리)
    // ========================================

    function generateDeviceFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('YU Mobile', 2, 2);

        deviceFingerprint = {
          userAgent: navigator.userAgent,
          screenInfo: `${screen.width}x${screen.height}x${screen.colorDepth}`,
          pixelRatio: window.devicePixelRatio || 1,
          timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone,
          language: navigator.language,
          platform: navigator.platform,
          canvasFingerprint: canvas.toDataURL().substring(0, 100),
          touchPoints: navigator.maxTouchPoints || 0,
          timestamp: Date.now()
        };
        
        console.log('🔧 기기 정보 수집 완료');
        
      } catch (error) {
        deviceFingerprint = {
          userAgent: navigator.userAgent || 'unknown',
          timestamp: Date.now(),
          fallback: true
        };
        console.log('🔧 기기 정보 수집 (폴백)');
      }
    }

    // ========================================
    // API 통신 - JSONP 방식
    // ========================================

    async function callGoogleScript(method, params = null) {
      return new Promise((resolve, reject) => {
        const callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substring(2);
        const timeoutId = setTimeout(() => {
          cleanup();
          reject(new Error('요청 시간 초과 (20초)'));
        }, 20000);

        function cleanup() {
          if (window[callbackName]) {
            delete window[callbackName];
          }
          clearTimeout(timeoutId);
          const script = document.getElementById(callbackName);
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        }

        window[callbackName] = function(result) {
          cleanup();
          resolve(result);
        };

        const script = document.createElement('script');
        script.id = callbackName;
        script.onerror = () => {
          cleanup();
          reject(new Error('네트워크 연결 오류'));
        };

        let url = `${BACKEND_URL}?method=${encodeURIComponent(method)}&callback=${callbackName}`;
        
        if (params) {
          const paramStr = encodeURIComponent(JSON.stringify(params));
          url += `&params=${paramStr}`;
        }

        script.src = url;
        document.head.appendChild(script);
      });
    }

    async function testBackendConnection() {
      const result = await callGoogleScript('testConnection');
      if (!result.success) {
        throw new Error(result.error || '연결 실패');
      }
      return result;
    }

    async function loadSettings() {
      try {
        const result = await callGoogleScript('getSettings');
        if (result && result.success !== false) {
          const settings = result.data || result;
          document.getElementById('meetingTitle').textContent = 
            settings.meeting_title || '교직원 회의 출석';
          document.getElementById('meetingDescription').textContent = 
            settings.meeting_description || '출석 정보를 입력해주세요';
        }
      } catch (error) {
        console.warn('설정 로드 실패:', error);
      }
    }

    // ========================================
    // 폼 처리 (개선)
    // ========================================

    function setupEventListeners() {
      ['name', 'department', 'email'].forEach(field => {
        const element = document.getElementById(field);
        element.addEventListener('input', () => {
          validateField(field);
          validateForm();
        });
        element.addEventListener('blur', () => validateField(field));
        
        // 모바일 포커스 개선
        element.addEventListener('focus', function() {
          setTimeout(() => {
            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });

      document.getElementById('attendanceForm').addEventListener('submit', handleFormSubmit);
      
      // 모바일 스크롤 이벤트
      window.addEventListener('resize', () => {
        validateForm();
      });
    }

    function validateField(fieldName) {
      const element = document.getElementById(fieldName);
      const validationElement = document.getElementById(fieldName + '-validation');
      const value = element.value.trim();
      
      let isValid = true;
      let message = '';

      if (!value) {
        isValid = false;
        message = '필수 항목입니다.';
      } else {
        switch(fieldName) {
          case 'name':
            if (value.length < 2) {
              isValid = false;
              message = '이름은 2자 이상 입력해주세요.';
            } else if (!/^[가-힣a-zA-Z\s]+$/.test(value)) {
              isValid = false;
              message = '한글, 영문만 입력 가능합니다.';
            }
            break;
            
          case 'department':
            if (value.length < 2) {
              isValid = false;
              message = '소속은 2자 이상 입력해주세요.';
            }
            break;
            
          case 'email':
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
              isValid = false;
              message = '올바른 이메일 형식을 입력해주세요.';
            }
            break;
        }
      }

      if (isValid) {
        element.classList.remove('invalid');
        validationElement.textContent = '';
        validationElement.classList.remove('show');
      } else {
        element.classList.add('invalid');
        validationElement.textContent = message;
        validationElement.classList.add('show');
      }

      return isValid;
    }

    function validateForm() {
      if (isCompleted) return;

      const name = document.getElementById('name').value.trim();
      const department = document.getElementById('department').value.trim();
      const email = document.getElementById('email').value.trim();

      const nameValid = name.length >= 2 && /^[가-힣a-zA-Z\s]+$/.test(name);
      const deptValid = department.length >= 2;
      const emailValid = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      
      const isFormValid = nameValid && deptValid && emailValid && isLocationValid && isSystemReady;
      
      updateSubmitButton(isFormValid);
    }

    function updateSubmitButton(isValid) {
      const submitBtn = document.getElementById('submitBtn');
      
      if (isCompleted) {
        submitBtn.disabled = true;
        submitBtn.textContent = '✅ 출석 완료';
        submitBtn.classList.remove('pulse');
      } else if (isSubmitting) {
        submitBtn.disabled = true;
        submitBtn.textContent = '📧 처리중...';
        submitBtn.classList.remove('pulse');
      } else if (!isSystemReady) {
        submitBtn.disabled = true;
        submitBtn.textContent = '⏳ 시스템 준비중...';
        submitBtn.classList.remove('pulse');
      } else if (!isLocationValid) {
        submitBtn.disabled = true;
        submitBtn.textContent = '📍 위치 확인 먼저 해주세요';
        submitBtn.classList.remove('pulse');
      } else if (isValid) {
        submitBtn.disabled = false;
        submitBtn.textContent = '✅ 출석 체크하기';
        submitBtn.classList.add('pulse');
      } else {
        submitBtn.disabled = true;
        submitBtn.textContent = '⏳ 모든 정보를 입력해주세요';
        submitBtn.classList.remove('pulse');
      }
    }

    // ========================================
    // 출석 제출
    // ========================================

    function handleFormSubmit(e) {
      e.preventDefault();
      
      if (isSubmitting || isCompleted || !isSystemReady || !isLocationValid) {
        return;
      }

      const formData = {
        name: document.getElementById('name').value.trim(),
        department: document.getElementById('department').value.trim(),
        email: document.getElementById('email').value.trim()
      };

      submitAttendance(formData);
    }

    function submitAttendance(formData) {
      isSubmitting = true;
      updateSubmitButton(false);
      showLoading(true, '📧 출석 정보 제출중...');

      if (lastKnownPosition) {
        processSubmission(formData, lastKnownPosition);
      } else {
        navigator.geolocation.getCurrentPosition(
          (position) => processSubmission(formData, position),
          (error) => {
            isSubmitting = false;
            showLoading(false);
            showAlert('위치 확인에 실패했습니다.\n"위치 확인하기" 버튼을 먼저 눌러주세요.', 'error');
            updateSubmitButton(true);
          }
        );
      }
    }

    async function processSubmission(formData, position) {
      const attendanceData = {
        ...formData,
        latitude: position.coords.latitude,
        longitude: position.coords.longitude,
        accuracy: position.coords.accuracy,
        timestamp: new Date().toISOString(),
        ...deviceFingerprint
      };

      try {
        const result = await callGoogleScript('saveAttendance', attendanceData);
        
        isSubmitting = false;
        showLoading(false);
        
        if (result.success) {
          completeAttendance(result);
        } else {
          const message = result.message || result.error || '출석 체크에 실패했습니다.';
          showAlert(message, 'error');
          updateSubmitButton(true);
        }
        
      } catch (error) {
        isSubmitting = false;
        showLoading(false);
        console.error('제출 오류:', error);
        
        showAlert('출석 체크 중 오류가 발생했습니다.\n잠시 후 다시 시도해주세요.', 'error');
        updateSubmitButton(true);
      }
    }

    function completeAttendance(result) {
      isCompleted = true;
      currentState = SystemState.COMPLETED;
      
      const completionDiv = document.getElementById('completionMessage');
      const completionDetails = document.getElementById('completionDetails');
      
      let details = `출석자: ${document.getElementById('name').value}\n`;
      details += `소속: ${document.getElementById('department').value}\n`;
      details += `시간: ${new Date().toLocaleString('ko-KR')}`;
      
      if (result.distance) {
        details += `\n거리: ${result.distance}m`;
      }
      
      if (result.emailSent) {
        details += `\n\n📧 확인 이메일 발송됨`;
      }
      
      completionDetails.textContent = details;
      completionDiv.style.display = 'block';
      
      updateSubmitButton(false);
      updateStatus('🎉 출석이 완료되었습니다!', 'ready');
      
      // 입력 필드 비활성화
      document.querySelectorAll('#attendanceForm input').forEach(input => {
        input.disabled = true;
      });

      // 부드러운 스크롤
      setTimeout(() => {
        completionDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 500);
      
      // 성공 피드백 (진동)
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
    }

    // ========================================
    // UI 헬퍼 함수
    // ========================================

    function updateStatus(message, type) {
      const indicator = document.getElementById('statusIndicator');
      indicator.textContent = message;
      indicator.className = `status-indicator status-${type}`;
    }

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(alert);

      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, type === 'success' ? 6000 : 8000);
    }

    function showLoading(show, text = '처리중입니다...') {
      const loading = document.getElementById('loading');
      const form = document.getElementById('attendanceForm');
      const loadingText = document.getElementById('loadingText');
      
      if (show) {
        loadingText.textContent = text;
        loading.style.display = 'block';
        form.style.opacity = '0.5';
        form.style.pointerEvents = 'none';
      } else {
        loading.style.display = 'none';
        form.style.opacity = '1';
        form.style.pointerEvents = 'auto';
      }
    }

    function showLocationHint() {
      const hint = document.getElementById('locationHint');
      hint.classList.add('show');
    }

    function hideLocationHint() {
      const hint = document.getElementById('locationHint');
      hint.classList.remove('show');
    }

    // ========================================
    // 모바일 최적화 이벤트
    // ========================================

    // 뷰포트 변경 대응
    window.addEventListener('orientationchange', function() {
      setTimeout(() => {
        window.scrollTo(0, 0);
        validateForm();
      }, 500);
    });

    // 터치 피드백
    document.addEventListener('touchstart', function() {}, { passive: true });

    console.log('🎓 용인대학교 출석 시스템 로드 완료 (모바일 최적화)');
  </script>
</body>
</html>
