<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="theme-color" content="#2c3e50">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>용인대학교 교직원 회의 출석</title>
  
  <style>
    /* ========================================
     * 50세 이상 사용자 맞춤 디자인
     * 큰 폰트, 큰 버튼, 고대비, 단순함
     * 구형 기기 호환성 최우선
     * ======================================== */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: "맑은 고딕", "Malgun Gothic", "Apple SD Gothic Neo", Arial, sans-serif;
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      min-height: 100vh;
      padding: 20px 16px;
      line-height: 1.5;
      overflow-x: hidden;
      font-size: 20px; /* 기본 폰트 크기 대폭 증가 */
      color: #333;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      min-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      padding: 40px 32px; /* 패딩 증가 */
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 12px;
    }

    .university-title {
      font-size: 36px; /* 대학교 이름 크게 */
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 12px;
      letter-spacing: -0.5px;
    }

    .meeting-title {
      font-size: 24px; /* 회의 제목 크게 */
      font-weight: bold;
      color: #34495e;
      margin-bottom: 8px;
    }

    .meeting-description {
      font-size: 18px;
      color: #7f8c8d;
      font-weight: 500;
    }

    .form-container {
      flex: 1;
    }

    /* 상태 표시 (매우 크고 명확하게) */
    .status-indicator {
      background: #ecf0f1;
      border: 3px solid #bdc3c7;
      border-radius: 16px;
      padding: 32px 24px; /* 패딩 대폭 증가 */
      text-align: center;
      font-size: 20px; /* 상태 텍스트 크게 */
      font-weight: bold;
      margin-bottom: 32px;
      min-height: 100px; /* 최소 높이 증가 */
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .status-ready {
      background: linear-gradient(135deg, #d5f4e6, #a7f3d0);
      border-color: #10b981;
      color: #047857;
    }

    .status-checking {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-color: #f59e0b;
      color: #92400e;
    }

    .status-error {
      background: linear-gradient(135deg, #fecaca, #fca5a5);
      border-color: #ef4444;
      color: #dc2626;
    }

    .form-group {
      margin-bottom: 28px; /* 간격 증가 */
    }

    .form-group label {
      display: block;
      margin-bottom: 12px;
      font-weight: bold;
      color: #2c3e50;
      font-size: 20px; /* 라벨 크기 증가 */
    }

    .required {
      color: #e74c3c;
      font-size: 22px;
    }

    .form-group input {
      width: 100%;
      padding: 24px 20px; /* 입력 필드 크기 대폭 증가 */
      border: 3px solid #bdc3c7;
      border-radius: 12px;
      font-size: 20px; /* 입력 텍스트 크기 증가 */
      font-family: inherit;
      background: #ffffff;
      color: #2c3e50;
      transition: all 0.3s ease;
      -webkit-appearance: none;
      appearance: none;
      min-height: 70px; /* 최소 높이 보장 */
    }

    .form-group input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
      transform: translateY(-2px);
    }

    .form-group input.invalid {
      border-color: #e74c3c;
      background: #fdf2f2;
      animation: shake 0.5s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-8px); }
      75% { transform: translateX(8px); }
    }

    .validation-message {
      font-size: 16px;
      margin-top: 12px;
      color: #e74c3c;
      font-weight: bold;
      opacity: 0;
      transition: all 0.3s ease;
      transform: translateY(-5px);
    }

    .validation-message.show {
      opacity: 1;
      transform: translateY(0);
    }

    /* 버튼 (50세 이상 친화적으로 대폭 확대) */
    .btn {
      width: 100%;
      padding: 28px 24px; /* 버튼 크기 대폭 증가 */
      border: none;
      border-radius: 16px;
      font-size: 22px; /* 버튼 폰트 크기 증가 */
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 20px;
      font-family: inherit;
      min-height: 80px; /* 최소 높이 보장 */
      display: flex;
      align-items: center;
      justify-content: center;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      box-shadow: 0 8px 24px rgba(52, 152, 219, 0.3);
      border: 3px solid transparent;
    }

    .btn-primary:not(:disabled):hover,
    .btn-primary:not(:disabled):focus {
      background: linear-gradient(135deg, #2980b9, #21618c);
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(52, 152, 219, 0.4);
    }

    .btn-secondary {
      background: #ffffff;
      color: #34495e;
      border: 3px solid #bdc3c7;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary:not(:disabled):hover,
    .btn-secondary:not(:disabled):focus {
      background: #ecf0f1;
      border-color: #95a5a6;
      transform: translateY(-1px);
    }

    .btn:disabled {
      background: #bdc3c7;
      color: #7f8c8d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      border-color: #bdc3c7;
    }

    /* 알림 메시지 (크고 명확하게) */
    .alert {
      padding: 28px 24px; /* 패딩 증가 */
      border-radius: 16px;
      margin-bottom: 24px;
      font-weight: bold;
      font-size: 18px; /* 알림 폰트 크기 증가 */
      border-left: 6px solid;
      line-height: 1.6;
      animation: slideIn 0.5s ease-out;
    }

    .alert-success {
      background: linear-gradient(135deg, #d5f4e6, #a7f3d0);
      color: #047857;
      border-color: #10b981;
    }

    .alert-error {
      background: linear-gradient(135deg, #fecaca, #fca5a5);
      color: #dc2626;
      border-color: #ef4444;
    }

    .alert-info {
      background: linear-gradient(135deg, #dbeafe, #bfdbfe);
      color: #1d4ed8;
      border-color: #3b82f6;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 로딩 (단순하게) */
    .loading {
      display: none;
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      border: 6px solid #ecf0f1;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 60px; /* 스피너 크기 증가 */
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 20px;
      font-weight: bold;
      color: #34495e;
    }

    /* 완료 메시지 */
    .completion-message {
      background: linear-gradient(135deg, #10b981, #047857);
      color: white;
      padding: 48px 32px; /* 패딩 증가 */
      border-radius: 20px;
      text-align: center;
      margin-top: 32px;
      display: none;
      animation: slideIn 0.8s ease-out;
    }

    .completion-icon {
      font-size: 80px; /* 아이콘 크기 증가 */
      margin-bottom: 24px;
      animation: bounce 2s infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .completion-text {
      font-size: 28px; /* 완료 텍스트 크기 증가 */
      font-weight: bold;
      margin-bottom: 20px;
    }

    .completion-details {
      font-size: 18px;
      line-height: 1.6;
      white-space: pre-line;
      opacity: 0.95;
    }

    .footer {
      text-align: center;
      padding: 24px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      font-weight: 500;
    }

    /* 위치 안내 */
    .location-hint {
      background: rgba(52, 152, 219, 0.1);
      border: 2px solid rgba(52, 152, 219, 0.3);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      font-size: 18px; /* 안내 텍스트 크기 증가 */
      color: #2c3e50;
      display: none;
      text-align: center;
      font-weight: bold;
    }

    .location-hint.show {
      display: block;
      animation: slideIn 0.5s ease-out;
    }

    .hidden {
      display: none;
    }

    /* 모바일 최적화 (50세 이상 고려) */
    @media (max-width: 480px) {
      body { 
        padding: 16px 12px; 
        font-size: 22px; /* 모바일에서 더 큰 폰트 */
      }
      
      .container { 
        gap: 20px;
      }
      
      .card { 
        padding: 36px 28px; 
        border-radius: 16px;
      }
      
      .university-title { 
        font-size: 32px; 
      }
      
      .meeting-title { 
        font-size: 20px; 
      }
      
      .form-group input { 
        padding: 28px 20px;
        font-size: 22px;
        min-height: 76px;
      }
      
      .btn {
        padding: 32px 20px;
        min-height: 88px;
        font-size: 24px;
      }
      
      .status-indicator {
        padding: 36px 20px;
        font-size: 22px;
        min-height: 110px;
      }
      
      .completion-icon {
        font-size: 72px;
      }
      
      .completion-text {
        font-size: 24px;
      }
    }

    /* 아이폰 X 이상 노치 대응 */
    @supports (padding: env(safe-area-inset-top)) {
      .container {
        padding-top: env(safe-area-inset-top);
        padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
      }
    }

    /* 가로 모드 대응 */
    @media (orientation: landscape) and (max-height: 500px) {
      .container {
        min-height: calc(100vh - 32px);
        gap: 16px;
      }
      
      .card {
        padding: 24px 28px;
      }
      
      .status-indicator {
        min-height: 80px;
        padding: 20px;
      }
      
      .university-title {
        font-size: 28px;
      }
    }

    /* 접근성 개선 */
    .btn:focus, input:focus {
      outline: 4px solid #f39c12;
      outline-offset: 3px;
    }

    /* 고대비 모드 지원 */
    @media (prefers-contrast: high) {
      .btn {
        border-width: 4px;
      }
      
      .form-group input {
        border-width: 4px;
      }
      
      .status-indicator {
        border-width: 4px;
      }
    }

    /* 애니메이션 축소 (50세 이상 고려) */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* 터치 친화적 간격 */
    .form-group {
      margin-bottom: 32px;
    }
    
    /* 큰 터치 영역 */
    .btn, input {
      min-width: 48px;
      min-height: 80px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 헤더 -->
    <div class="card header">
      <h1 class="university-title">용인대학교</h1>
      <h2 class="meeting-title" id="meetingTitle">교직원 회의 출석</h2>
      <p class="meeting-description" id="meetingDescription">출석 정보를 정확히 입력해주세요</p>
    </div>

    <!-- 메인 폼 -->
    <div class="card form-container">
      <div id="alertContainer"></div>
      
      <!-- 위치 권한 안내 -->
      <div class="location-hint" id="locationHint">
        위치 권한을 허용해주세요.<br>
        브라우저에서 "허용" 버튼을 눌러주세요.
      </div>
      
      <!-- 상태 표시 -->
      <div class="status-indicator" id="statusIndicator">
        시스템을 준비하고 있습니다...
      </div>
      
      <!-- 로딩 -->
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText" class="loading-text">처리중입니다...</p>
      </div>

      <!-- 출석 폼 -->
      <form id="attendanceForm">
        <div class="form-group">
          <label for="name">
            성명 <span class="required">*</span>
          </label>
          <input type="text" id="name" placeholder="홍길동" maxlength="20" required>
          <div class="validation-message" id="name-validation"></div>
        </div>

        <div class="form-group">
          <label for="department">
            소속 <span class="required">*</span>
          </label>
          <input type="text" id="department" placeholder="경영학과, 교무팀 등" maxlength="50" required>
          <div class="validation-message" id="department-validation"></div>
        </div>

        <div class="form-group">
          <label for="email">
            이메일 <span class="required">*</span>
          </label>
          <input type="email" id="email" placeholder="name@yongin.ac.kr" maxlength="100" required 
                 autocomplete="username email" 
                 autocapitalize="none" 
                 autocorrect="off"
                 name="user_email"
                 list="email-suggestions">
          <datalist id="email-suggestions">
            <option value="@yongin.ac.kr">
            <option value="@yi.ac.kr">  
            <option value="@gmail.com">
            <option value="@naver.com">
            <option value="@daum.net">
            <option value="@hanmail.net">
          </datalist>
          <div class="validation-message" id="email-validation"></div>
        </div>

        <!-- 출석 체크 버튼 -->
        <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
          출석 체크하기
        </button>

        <!-- 위치 확인 버튼 -->
        <button type="button" class="btn btn-secondary" onclick="recheckLocation()" id="locationBtn">
          위치 다시 확인하기
        </button>

        <!-- 완료 메시지 -->
        <div class="completion-message" id="completionMessage">
          <div class="completion-icon">✅</div>
          <div class="completion-text">출석 완료!</div>
          <div class="completion-details" id="completionDetails"></div>
        </div>
      </form>
    </div>

    <!-- 푸터 -->
    <div class="footer">
      용인대학교 출석시스템 © 2025
    </div>
  </div>

  <script>
    // ========================================
    // 50세 이상 사용자 + 구형 기기 호환성 최우선
    // ES5 문법, 단순한 로직, 명확한 메시지
    // ========================================
    
    // 설정 (관리자가 수정)
    var BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzYDZWn1OzOGiQ8OOeeepVhZjpMMfeoAfZ7AlFXg2w8yQWKSvEw9X7WQXxYaVF5RjTtAA/exec';
    
    // 전역 변수 (구형 브라우저 호환)
    var isLocationValid = false;
    var isSystemReady = false;
    var isCompleted = false;
    var isSubmitting = false;
    var deviceInfo = null;
    var lastKnownPosition = null;
    var locationRequested = false;
    var locationSettings = {
      target_latitude: 37.2420,
      target_longitude: 127.1775,
      location_radius: 1200
    };

    // 기기 정보
    var isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    var isOldDevice = false;

    console.log('용인대학교 출석 시스템 시작 (50세+ 최적화, 기기 호환성 강화)');

    /**
     * 페이지 로드 시 초기화 (구형 브라우저 지원)
     */
    if (window.addEventListener) {
      window.addEventListener('load', function() {
        console.log('페이지 로드 완료');
        initializeSystem();
      });
    } else if (window.attachEvent) { // IE8 이하
      window.attachEvent('onload', function() {
        console.log('페이지 로드 완료 (IE)');
        initializeSystem();
      });
    }

    /**
     * 시스템 초기화 (단순화)
     */
    function initializeSystem() {
      try {
        console.log('시스템 초기화 시작');
        
        // 1. 기기 정보 수집
        collectDeviceInfo();
        
        // 2. 구형 기기 감지
        detectOldDevice();
        
        // 3. 이벤트 리스너 설정
        setupEventListeners();
        
        // 4. 이메일 자동 감지 시도
        tryAutoFillEmail();
        
        // 5. 시스템 준비 완료
        isSystemReady = true;
        updateStatus('위치 확인이 필요합니다', 'checking');
        
        // 6. 백그라운드에서 설정 로드
        setTimeout(function() {
          loadSettingsFromServer();
        }, 1000);
        
        // 7. 자동 위치 확인 시작
        setTimeout(function() {
          startLocationCheck();
        }, 2000);
        
        console.log('시스템 초기화 완료');
        
      } catch (error) {
        console.error('시스템 초기화 오류:', error);
        updateStatus('시스템 준비 중 오류가 발생했습니다', 'error');
        showAlert('시스템 초기화에 실패했습니다.\n페이지를 새로고침해주세요.', 'error');
      }
    }

    /**
     * 이메일 자동 채우기 시도
     */
    function tryAutoFillEmail() {
      try {
        // 1. Credential Management API 시도 (최신 브라우저)
        if (window.navigator && navigator.credentials && navigator.credentials.get) {
          console.log('Credential API 시도');
          
          navigator.credentials.get({
            password: true,
            federated: {
              providers: ['https://accounts.google.com']
            }
          }).then(function(credential) {
            if (credential && credential.id && credential.id.includes('@')) {
              console.log('자동 이메일 감지 성공');
              document.getElementById('email').value = credential.id;
              validateField('email');
              validateForm();
            }
          }).catch(function(error) {
            console.log('Credential API 실패:', error.message);
            tryAlternativeEmailDetection();
          });
          
        } else {
          tryAlternativeEmailDetection();
        }
        
      } catch (error) {
        console.log('이메일 자동 감지 오류:', error);
        tryAlternativeEmailDetection();
      }
    }

    /**
     * 대안적 이메일 감지 방법
     */
    function tryAlternativeEmailDetection() {
      try {
        // 브라우저 자동완성 트리거
        var emailField = document.getElementById('email');
        if (emailField) {
          // 포커스 후 즉시 블러하여 자동완성 트리거
          emailField.focus();
          setTimeout(function() {
            emailField.blur();
            emailField.focus();
          }, 100);
        }
        
      } catch (error) {
        console.log('대안 이메일 감지 실패:', error);
      }
    }

    /**
     * 기기 정보 수집 (안전하게)
     */
    function collectDeviceInfo() {
      try {
        deviceInfo = {
          userAgent: navigator.userAgent || 'unknown',
          platform: navigator.platform || 'unknown',
          language: navigator.language || 'ko',
          timeZone: 'Asia/Seoul',
          timestamp: new Date().getTime()
        };
        
        // 화면 정보 (안전하게)
        if (window.screen) {
          deviceInfo.screenInfo = screen.width + 'x' + screen.height;
          if (screen.colorDepth) {
            deviceInfo.screenInfo += 'x' + screen.colorDepth;
          }
        } else {
          deviceInfo.screenInfo = 'unknown';
        }
        
        // 터치 지원 (안전하게)
        if (navigator.maxTouchPoints !== undefined) {
          deviceInfo.touchPoints = navigator.maxTouchPoints;
        } else if (navigator.msMaxTouchPoints !== undefined) {
          deviceInfo.touchPoints = navigator.msMaxTouchPoints;
        } else {
          deviceInfo.touchPoints = 0;
        }
        
        console.log('기기 정보 수집 완료');
        
      } catch (error) {
        console.error('기기 정보 수집 오류:', error);
        deviceInfo = {
          userAgent: 'error',
          timestamp: new Date().getTime(),
          fallback: true
        };
      }
    }

    /**
     * 구형 기기 감지
     */
    function detectOldDevice() {
      try {
        var userAgent = navigator.userAgent;
        
        // 구형 기기 패턴
        var oldPatterns = [
          /iPhone.*OS [1-9]_/i,      // iOS 9 이하
          /Android [1-4]\./i,        // Android 4 이하
          /MSIE/i,                   // Internet Explorer
          /Trident/i,                // IE 호환 모드
          /Opera Mini/i              // Opera Mini
        ];
        
        for (var i = 0; i < oldPatterns.length; i++) {
          if (oldPatterns[i].test(userAgent)) {
            isOldDevice = true;
            console.log('구형 기기 감지됨');
            break;
          }
        }
        
        // 구형 기기 특별 처리
        if (isOldDevice) {
          // 애니메이션 비활성화
          var style = document.createElement('style');
          style.textContent = '* { animation: none !important; transition: none !important; }';
          document.head.appendChild(style);
          
          console.log('구형 기기 최적화 적용');
        }
        
      } catch (error) {
        console.error('구형 기기 감지 오류:', error);
      }
    }

    /**
     * 이벤트 리스너 설정 (구형 브라우저 호환)
     */
    function setupEventListeners() {
      try {
        // 입력 필드 검증
        var fields = ['name', 'department', 'email'];
        for (var i = 0; i < fields.length; i++) {
          var field = fields[i];
          var element = document.getElementById(field);
          
          if (element) {
            // 구형 브라우저 호환 이벤트 리스너
            if (element.addEventListener) {
              element.addEventListener('input', createFieldValidator(field));
              element.addEventListener('blur', createFieldValidator(field));
              element.addEventListener('focus', createFieldFocusHandler());
            } else if (element.attachEvent) { // IE8 이하
              element.attachEvent('onpropertychange', createFieldValidator(field));
              element.attachEvent('onblur', createFieldValidator(field));
            }
          }
        }

        // 폼 제출 이벤트
        var form = document.getElementById('attendanceForm');
        if (form) {
          if (form.addEventListener) {
            form.addEventListener('submit', handleFormSubmit);
          } else if (form.attachEvent) {
            form.attachEvent('onsubmit', handleFormSubmit);
          }
        }
        
        console.log('이벤트 리스너 설정 완료');
        
      } catch (error) {
        console.error('이벤트 리스너 설정 오류:', error);
      }
    }

    /**
     * 필드 검증기 생성 (클로저 사용)
     */
    function createFieldValidator(fieldName) {
      return function() {
        validateField(fieldName);
        validateForm();
      };
    }

    /**
     * 필드 포커스 핸들러 생성
     */
    function createFieldFocusHandler() {
      return function() {
        var self = this;
        setTimeout(function() {
          if (self.scrollIntoView) {
            self.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
      };
    }

    /**
     * 설정 로드 (에러 처리 강화)
     */
    function loadSettingsFromServer() {
      try {
        console.log('서버에서 설정 로드 시도');
        
        callGoogleScript('getSettings', null)
          .then(function(result) {
            if (result && typeof result === 'object') {
              console.log('설정 로드 성공');
              updateSettingsFromServer(result);
            } else {
              console.log('설정 로드 실패, 기본값 사용');
            }
          })
          .catch(function(error) {
            console.log('설정 로드 오류:', error.message);
            console.log('기본 설정값 사용');
          });
          
      } catch (error) {
        console.log('설정 로드 중 예외:', error);
      }
    }

    function updateSettingsFromServer(settings) {
      try {
        // UI 업데이트
        var titleElement = document.getElementById('meetingTitle');
        var descElement = document.getElementById('meetingDescription');
        
        if (titleElement && settings.meeting_title) {
          titleElement.textContent = settings.meeting_title;
        }
        
        if (descElement && settings.meeting_description) {
          descElement.textContent = settings.meeting_description;
        }
        
        // 위치 설정 업데이트
        if (settings.target_latitude && settings.target_longitude) {
          locationSettings.target_latitude = parseFloat(settings.target_latitude);
          locationSettings.target_longitude = parseFloat(settings.target_longitude);
        }
        
        if (settings.location_radius) {
          locationSettings.location_radius = parseFloat(settings.location_radius);
        }
        
        console.log('설정 적용 완료:', locationSettings);
        
      } catch (error) {
        console.error('설정 적용 오류:', error);
      }
    }

    /**
     * 위치 확인 시작 (50세 이상 친화적)
     */
    function startLocationCheck() {
      try {
        if (!navigator.geolocation) {
          updateStatus('이 기기는 위치 확인을 지원하지 않습니다', 'error');
          showLocationHint();
          return;
        }

        updateStatus('위치를 확인하고 있습니다...', 'checking');
        showLocationHint();
        
        console.log('위치 확인 시작');
        
        // 구형 기기를 위한 단순한 위치 확인
        var options = {
          enableHighAccuracy: !isOldDevice, // 구형 기기는 낮은 정확도로
          timeout: isOldDevice ? 30000 : 15000, // 구형 기기는 더 오래 기다림
          maximumAge: 60000
        };
        
        navigator.geolocation.getCurrentPosition(
          handleLocationSuccess,
          handleLocationError,
          options
        );
        
      } catch (error) {
        console.error('위치 확인 시작 오류:', error);
        updateStatus('위치 확인 중 오류가 발생했습니다', 'error');
      }
    }

    /**
     * 위치 성공 처리 (단순화)
     */
    function handleLocationSuccess(position) {
      try {
        lastKnownPosition = position;
        locationRequested = true;
        
        var userLat = position.coords.latitude;
        var userLng = position.coords.longitude;
        var accuracy = position.coords.accuracy;
        
        console.log('위치 확인 성공:', {
          lat: userLat, 
          lng: userLng, 
          accuracy: accuracy
        });
        
        // 거리 계산
        var distance = calculateDistance(
          userLat, userLng, 
          locationSettings.target_latitude, locationSettings.target_longitude
        );
        
        // 기기별 허용 반경 계산 (단순화)
        var allowedRadius = calculateAllowedRadius(accuracy);
        
        console.log('거리:', distance, 'm, 허용 반경:', allowedRadius, 'm');
        
        if (distance <= allowedRadius) {
          isLocationValid = true;
          
          var message = '위치 확인 완료';
          if (distance < 100) {
            message += ' - 매우 가까움';
          } else if (distance < 500) {
            message += ' - 가까움 (' + Math.round(distance) + 'm)';
          } else {
            message += ' - 실내 환경 (' + Math.round(distance) + 'm)';
          }
          
          updateStatus(message, 'ready');
          hideLocationHint();
          validateForm();
          
          console.log('위치 검증 성공!');
          
          // 50세 이상을 위한 성공 알림
          if (distance > 800) {
            showAlert(
              '위치 확인이 완료되었습니다.\n\n' +
              '현재 거리: ' + Math.round(distance) + 'm\n' +
              '허용 거리: ' + allowedRadius + 'm 이내\n\n' +
              '실내에서는 GPS가 부정확할 수 있어\n' +
              '허용 거리를 넓게 설정했습니다.',
              'success'
            );
          }
          
        } else {
          isLocationValid = false;
          
          var errorMessage = '회의실에서 ' + Math.round(distance) + 'm 떨어져 있습니다';
          updateStatus(errorMessage, 'error');
          hideLocationHint();
          
          // 50세 이상을 위한 상세한 안내
          var detailMessage = '위치가 회의실에서 너무 멀리 떨어져 있습니다.\n\n';
          detailMessage += '현재 거리: ' + Math.round(distance) + 'm\n';
          detailMessage += '허용 거리: ' + allowedRadius + 'm 이내\n';
          detailMessage += '초과 거리: ' + Math.round(distance - allowedRadius) + 'm\n\n';
          
          if (isMobile) {
            detailMessage += '스마트폰 안내:\n';
            detailMessage += '• WiFi를 켜주세요\n';
            detailMessage += '• 창가로 이동해보세요\n';
            detailMessage += '• "위치 다시 확인" 버튼을 눌러보세요\n';
          } else {
            detailMessage += '컴퓨터 안내:\n';
            detailMessage += '• 가능하면 스마트폰을 사용해주세요\n';
            detailMessage += '• WiFi 연결을 확인해주세요\n';
          }
          
          showAlert(detailMessage, 'error');
          validateForm();
        }
        
      } catch (error) {
        console.error('위치 성공 처리 오류:', error);
        updateStatus('위치 처리 중 오류가 발생했습니다', 'error');
      }
    }

    /**
     * 위치 오류 처리 (50세 이상 친화적 메시지)
     */
    function handleLocationError(error) {
      try {
        isLocationValid = false;
        
        var errorMessage = '위치 확인이 필요합니다';
        var alertMessage = '';
        
        console.log('위치 오류:', error.code, error.message);
        
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = '위치 권한이 필요합니다';
            alertMessage = '위치 권한을 허용해주세요.\n\n';
            
            if (isMobile) {
              alertMessage += '스마트폰 설정 방법:\n';
              alertMessage += '1. 브라우저 주소창 왼쪽의 자물쇠 아이콘을 누르세요\n';
              alertMessage += '2. "위치" 항목을 "허용"으로 바꾸세요\n';
              alertMessage += '3. "위치 다시 확인" 버튼을 누르세요\n\n';
            } else {
              alertMessage += '컴퓨터 설정 방법:\n';
              alertMessage += '1. 주소창 왼쪽의 자물쇠를 클릭하세요\n';
              alertMessage += '2. 위치를 "허용"으로 바꾸세요\n';
              alertMessage += '3. "위치 다시 확인" 버튼을 누르세요\n\n';
            }
            
            alertMessage += '※ 권한을 허용한 후 버튼을 눌러주세요';
            break;
            
          case error.POSITION_UNAVAILABLE:
            errorMessage = 'GPS 신호가 약합니다';
            alertMessage = 'GPS 신호를 개선해주세요.\n\n';
            alertMessage += '개선 방법:\n';
            alertMessage += '• 창문 근처로 이동해보세요\n';
            alertMessage += '• WiFi를 켜두세요\n';
            alertMessage += '• 지하나 밀폐된 공간을 피해주세요\n';
            alertMessage += '• 잠시 후 다시 시도해주세요\n\n';
            alertMessage += '"위치 다시 확인" 버튼을 눌러주세요';
            break;
            
          case error.TIMEOUT:
            errorMessage = '위치 확인 시간이 오래 걸립니다';
            alertMessage = '위치 확인에 시간이 오래 걸리고 있습니다.\n\n';
            alertMessage += '해결 방법:\n';
            alertMessage += '• 잠시 기다린 후 다시 시도해주세요\n';
            alertMessage += '• 다른 장소로 이동해보세요\n';
            alertMessage += '• WiFi와 모바일 데이터를 모두 켜두세요\n\n';
            alertMessage += '"위치 다시 확인" 버튼을 눌러주세요';
            break;
        }
        
        updateStatus(errorMessage, 'checking');
        showLocationHint();
        
        if (alertMessage) {
          setTimeout(function() {
            showAlert(alertMessage, 'info');
          }, 1000);
        }
        
        validateForm();
        
      } catch (error) {
        console.error('위치 오류 처리 중 예외:', error);
        updateStatus('위치 확인 중 오류가 발생했습니다', 'error');
      }
    }

    /**
     * 허용 반경 계산 (기기별 최적화)
     */
    function calculateAllowedRadius(accuracy) {
      var baseRadius = locationSettings.location_radius;
      var multiplier = 1.0;
      
      // 구형 기기 추가 보정
      if (isOldDevice) {
        multiplier = 3.0;
      } else if (isMobile) {
        multiplier = 2.5; // 모바일 기기
      } else {
        multiplier = 3.0; // 데스크탑 (WiFi 위치)
      }
      
      // GPS 정확도에 따른 추가 보정
      if (accuracy > 1000) {
        multiplier = multiplier * 2.0;
      } else if (accuracy > 500) {
        multiplier = multiplier * 1.5;
      } else if (accuracy > 200) {
        multiplier = multiplier * 1.3;
      }
      
      var effectiveRadius = baseRadius * multiplier;
      
      // 최소/최대 제한
      effectiveRadius = Math.max(500, effectiveRadius);
      effectiveRadius = Math.min(5000, effectiveRadius);
      
      return Math.round(effectiveRadius);
    }

    /**
     * 거리 계산 (Haversine formula)
     */
    function calculateDistance(lat1, lng1, lat2, lng2) {
      var R = 6371000; // 지구 반지름 (미터)
      var dLat = (lat2 - lat1) * Math.PI / 180;
      var dLng = (lng2 - lng1) * Math.PI / 180;
      
      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
      
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      
      return R * c;
    }

    /**
     * 위치 재확인 (50세 이상 친화적)
     */
    function recheckLocation() {
      var button = document.getElementById('locationBtn');
      if (!button) return;
      
      var originalText = button.textContent;
      
      button.disabled = true;
      button.textContent = '위치 확인중...';
      
      try {
        if (!navigator.geolocation) {
          throw new Error('이 기기는 위치 확인을 지원하지 않습니다');
        }

        updateStatus('위치를 다시 확인하고 있습니다...', 'checking');
        showLocationHint();
        
        // 더 관대한 옵션으로 재시도
        var options = {
          enableHighAccuracy: true,
          timeout: 20000, // 더 길게 기다림
          maximumAge: 10000 // 최근 위치 사용 가능
        };
        
        navigator.geolocation.getCurrentPosition(
          function(position) {
            button.disabled = false;
            button.textContent = originalText;
            handleLocationSuccess(position);
            
            if (isLocationValid) {
              showAlert('위치 재확인이 완료되었습니다!', 'success');
            }
          },
          function(error) {
            button.disabled = false;
            button.textContent = originalText;
            handleLocationError(error);
          },
          options
        );
        
      } catch (error) {
        button.disabled = false;
        button.textContent = originalText;
        
        updateStatus('위치 확인 실패', 'error');
        showAlert(
          '위치 확인에 실패했습니다.\n\n' +
          '다음을 확인해주세요:\n' +
          '• 위치 권한이 허용되어 있는지\n' +
          '• WiFi나 모바일 데이터가 연결되어 있는지\n' +
          '• 창가나 실외로 이동해보세요',
          'error'
        );
      }
    }

    /**
     * 필드 검증 (단순화)
     */
    function validateField(fieldName) {
      var element = document.getElementById(fieldName);
      var validationElement = document.getElementById(fieldName + '-validation');
      
      if (!element || !validationElement) return false;
      
      var value = element.value;
      if (value && value.replace) {
        value = value.replace(/^\s+|\s+$/g, ''); // trim() 대체
      } else {
        value = '';
      }
      
      var isValid = true;
      var message = '';

      if (!value) {
        isValid = false;
        message = '필수 항목입니다.';
      } else {
        switch(fieldName) {
          case 'name':
            if (value.length < 2) {
              isValid = false;
              message = '이름은 2자 이상 입력해주세요.';
            } else if (!/^[가-힣a-zA-Z\s\-\.]+$/.test(value)) {
              isValid = false;
              message = '한글, 영문만 입력 가능합니다.';
            }
            break;
            
          case 'department':
            if (value.length < 2) {
              isValid = false;
              message = '소속은 2자 이상 입력해주세요.';
            }
            break;
            
          case 'email':
            // 간단한 이메일 검증
            if (value.indexOf('@') === -1 || value.indexOf('.') === -1) {
              isValid = false;
              message = '올바른 이메일 형식을 입력해주세요.';
            }
            break;
        }
      }

      if (isValid) {
        element.className = element.className.replace(' invalid', '');
        validationElement.textContent = '';
        validationElement.className = validationElement.className.replace(' show', '');
      } else {
        if (element.className.indexOf('invalid') === -1) {
          element.className += ' invalid';
        }
        validationElement.textContent = message;
        if (validationElement.className.indexOf('show') === -1) {
          validationElement.className += ' show';
        }
      }

      return isValid;
    }

    function validateForm() {
      if (isCompleted) return;

      var nameValid = validateField('name');
      var deptValid = validateField('department');
      var emailValid = validateField('email');
      
      var isFormValid = nameValid && deptValid && emailValid && isLocationValid && isSystemReady;
      
      updateSubmitButton(isFormValid);
    }

    function updateSubmitButton(isValid) {
      var submitBtn = document.getElementById('submitBtn');
      if (!submitBtn) return;
      
      if (isCompleted) {
        submitBtn.disabled = true;
        submitBtn.textContent = '출석 완료됨';
      } else if (isSubmitting) {
        submitBtn.disabled = true;
        submitBtn.textContent = '처리중입니다...';
      } else if (!isSystemReady) {
        submitBtn.disabled = true;
        submitBtn.textContent = '시스템 준비중...';
      } else if (!isLocationValid) {
        submitBtn.disabled = true;
        submitBtn.textContent = '위치 확인 후 출석 체크';
      } else if (isValid) {
        submitBtn.disabled = false;
        submitBtn.textContent = '출석 체크하기';
      } else {
        submitBtn.disabled = true;
        submitBtn.textContent = '모든 정보를 정확히 입력해주세요';
      }
    }

    /**
     * 폼 제출 처리
     */
    function handleFormSubmit(e) {
      if (e && e.preventDefault) {
        e.preventDefault();
      } else if (window.event) {
        window.event.returnValue = false;
      }
      
      if (isSubmitting || isCompleted || !isSystemReady || !isLocationValid) {
        return false;
      }

      var formData = {
        name: document.getElementById('name').value.replace(/^\s+|\s+$/g, ''),
        department: document.getElementById('department').value.replace(/^\s+|\s+$/g, ''),
        email: document.getElementById('email').value.replace(/^\s+|\s+$/g, '')
      };

      submitAttendance(formData);
      return false;
    }

    function submitAttendance(formData) {
      isSubmitting = true;
      updateSubmitButton(false);
      showLoading(true, '출석 정보를 전송하고 있습니다...');

      if (lastKnownPosition) {
        processSubmission(formData, lastKnownPosition);
      } else {
        // 위치 정보가 없으면 다시 확인
        navigator.geolocation.getCurrentPosition(
          function(position) {
            processSubmission(formData, position);
          },
          function(error) {
            isSubmitting = false;
            showLoading(false);
            showAlert('위치 확인에 실패했습니다.\n"위치 다시 확인" 버튼을 먼저 눌러주세요.', 'error');
            updateSubmitButton(true);
          }
        );
      }
    }

    /**
     * 제출 처리 (최종)
     */
    function processSubmission(formData, position) {
      try {
        // 출석 데이터 구성
        var attendanceData = {
          name: formData.name,
          department: formData.department,
          email: formData.email,
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          accuracy: position.coords.accuracy,
          timestamp: new Date().toISOString()
        };
        
        // 기기 정보 추가
        for (var key in deviceInfo) {
          attendanceData[key] = deviceInfo[key];
        }
        
        showLoading(true, '서버에 출석 정보를 저장하고 있습니다...');
        
        callGoogleScript('saveAttendance', attendanceData)
          .then(function(result) {
            isSubmitting = false;
            showLoading(false);
            
            if (result && result.success) {
              completeAttendance(result);
            } else {
              var message = result.error || result.message || '출석 체크에 실패했습니다.';
              showAlert(message, 'error');
              
              // 위치 오류인 경우 위치 재확인 유도
              if (message.indexOf('회의실') > -1 || message.indexOf('위치') > -1) {
                isLocationValid = false;
                updateStatus('위치를 다시 확인해주세요', 'checking');
              }
              
              updateSubmitButton(true);
            }
          })
          .catch(function(error) {
            isSubmitting = false;
            showLoading(false);
            console.error('제출 오류:', error);
            
            var errorMessage = '출석 체크 중 오류가 발생했습니다.\n잠시 후 다시 시도해주세요.';
            
            if (error.message && error.message.indexOf('네트워크') > -1) {
              errorMessage = '인터넷 연결에 문제가 있습니다.\n연결을 확인하고 다시 시도해주세요.';
            }
            
            showAlert(errorMessage, 'error');
            updateSubmitButton(true);
          });
          
      } catch (error) {
        isSubmitting = false;
        showLoading(false);
        console.error('제출 처리 오류:', error);
        showAlert('출석 정보 처리 중 오류가 발생했습니다.', 'error');
        updateSubmitButton(true);
      }
    }

    function completeAttendance(result) {
      isCompleted = true;
      
      var completionDiv = document.getElementById('completionMessage');
      var completionDetails = document.getElementById('completionDetails');
      
      if (completionDiv && completionDetails) {
        var details = '출석자: ' + document.getElementById('name').value + '\n';
        details += '소속: ' + document.getElementById('department').value + '\n';
        details += '시간: ' + new Date().toLocaleString() + '\n';
        
        if (result.distance) {
          details += '거리: ' + result.distance + 'm\n';
        }
        
        if (result.emailSent) {
          details += '\n확인 이메일이 발송되었습니다.';
        }
        
        completionDetails.textContent = details;
        completionDiv.style.display = 'block';
      }
      
      updateSubmitButton(false);
      updateStatus('출석이 완료되었습니다!', 'ready');
      
      // 입력 필드 비활성화
      var inputs = document.querySelectorAll('#attendanceForm input');
      for (var i = 0; i < inputs.length; i++) {
        inputs[i].disabled = true;
      }

      // 완료 메시지로 스크롤
      setTimeout(function() {
        if (completionDiv && completionDiv.scrollIntoView) {
          completionDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 500);
      
      // 성공 피드백 (진동)
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
    }

    // ========================================
    // Google Apps Script 통신 (JSONP 방식)
    // ========================================

    function callGoogleScript(method, params) {
      return new Promise(function(resolve, reject) {
        var callbackName = 'gasCallback_' + Date.now() + '_' + Math.random().toString(36).substring(2, 8);
        var timeoutId = setTimeout(function() {
          cleanup();
          reject(new Error('요청 시간 초과 (30초)'));
        }, 30000); // 50세 이상을 위해 시간 연장

        function cleanup() {
          if (window[callbackName]) {
            try {
              delete window[callbackName];
            } catch (error) {
              window[callbackName] = undefined;
            }
          }
          
          if (timeoutId) {
            clearTimeout(timeoutId);
          }
          
          var script = document.getElementById(callbackName);
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        }

        window[callbackName] = function(result) {
          cleanup();
          resolve(result);
        };

        try {
          var script = document.createElement('script');
          script.id = callbackName;
          script.onerror = function() {
            cleanup();
            reject(new Error('네트워크 연결 오류'));
          };

          var url = BACKEND_URL + '?method=' + encodeURIComponent(method) + '&callback=' + callbackName;
          
          if (params) {
            var paramStr = encodeURIComponent(JSON.stringify(params));
            url += '&params=' + paramStr;
          }

          script.src = url;
          document.head.appendChild(script);
          
        } catch (error) {
          cleanup();
          reject(new Error('스크립트 로드 오류: ' + error.message));
        }
      });
    }

    // ========================================
    // UI 헬퍼 함수 (50세 이상 친화적)
    // ========================================

    function updateStatus(message, type) {
      var indicator = document.getElementById('statusIndicator');
      if (!indicator) return;
      
      indicator.textContent = message;
      indicator.className = 'status-indicator status-' + type;
    }

    function showAlert(message, type) {
      var container = document.getElementById('alertContainer');
      if (!container) return;
      
      var alert = document.createElement('div');
      alert.className = 'alert alert-' + (type || 'info');
      alert.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(alert);

      setTimeout(function() {
        if (alert.parentNode) {
          alert.remove();
        }
      }, type === 'success' ? 8000 : 12000); // 50세 이상을 위해 더 오래 표시
    }

    function showLoading(show, text) {
      var loading = document.getElementById('loading');
      var form = document.getElementById('attendanceForm');
      var loadingText = document.getElementById('loadingText');
      
      if (!loading || !form || !loadingText) return;
      
      if (show) {
        loadingText.textContent = text || '처리중입니다...';
        loading.style.display = 'block';
        form.style.opacity = '0.5';
        form.style.pointerEvents = 'none';
      } else {
        loading.style.display = 'none';
        form.style.opacity = '1';
        form.style.pointerEvents = 'auto';
      }
    }

    function showLocationHint() {
      var hint = document.getElementById('locationHint');
      if (hint && hint.className.indexOf('show') === -1) {
        hint.className += ' show';
      }
    }

    function hideLocationHint() {
      var hint = document.getElementById('locationHint');
      if (hint) {
        hint.className = hint.className.replace(' show', '');
      }
    }

    // ========================================
    // 기타 이벤트 처리
    // ========================================

    // 뷰포트 변경 대응
    if (window.addEventListener) {
      window.addEventListener('orientationchange', function() {
        setTimeout(function() {
          window.scrollTo(0, 0);
          validateForm();
        }, 500);
      });
    }

    // 페이지 언로드 시 정리
    if (window.addEventListener) {
      window.addEventListener('beforeunload', function() {
        // 정리 작업
        console.log('페이지 언로드');
      });
    }

    console.log('용인대학교 출석 시스템 로드 완료 (50세+ 최적화, 구형 기기 호환)');
  </script>
</body>
</html>
